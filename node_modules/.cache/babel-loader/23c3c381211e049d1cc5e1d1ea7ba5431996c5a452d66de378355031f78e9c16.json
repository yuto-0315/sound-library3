{"ast":null,"code":"import _objectSpread from\"/Users/nakataniyuutomo/Desktop/Programing/\\u30BB\\u3099\\u30DF\\u958B\\u767A/sound-library2/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useRef,useEffect,useCallback}from'react';import'./DAWPage.css';// DAWã®å®šæ•°\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const BEAT_WIDTH=100;// 1æ‹ã®å¹…ï¼ˆpxï¼‰\nconst BEATS_PER_MEASURE=4;// 1å°ç¯€ã‚ãŸã‚Šã®æ‹æ•°\nconst MEASURE_WIDTH=BEAT_WIDTH*BEATS_PER_MEASURE;// 1å°ç¯€ã®å¹…ï¼ˆ400pxï¼‰\nconst SUB_BEAT_WIDTH=BEAT_WIDTH/2;// 8åˆ†éŸ³ç¬¦ã®å¹…ï¼ˆ50pxï¼‰\nconst TOTAL_MEASURES=16;// è¡¨ç¤ºã™ã‚‹å°ç¯€æ•°\nconst TOTAL_BEATS=TOTAL_MEASURES*BEATS_PER_MEASURE;// ç·æ‹æ•°\nconst DAWPage=()=>{// ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆç”¨ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼\nconst trackIdCounterRef=useRef(1);// ãƒˆãƒ©ãƒƒã‚¯åã®ç•ªå·ç®¡ç†ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼\nconst trackNameCounterRef=useRef(1);// LocalStorageã‹ã‚‰ã®è‡ªå‹•å¾©å…ƒæ©Ÿèƒ½\nconst loadAutoSavedProject=()=>{try{const autoSavedData=localStorage.getItem('dawProjectAutoSave');if(autoSavedData){const projectData=JSON.parse(autoSavedData);console.log('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒä¸­...',projectData);// ãƒˆãƒ©ãƒƒã‚¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å¾©å…ƒ\nif(projectData.trackNameCounter){trackNameCounterRef.current=projectData.trackNameCounter;}if(projectData.trackIdCounter){trackIdCounterRef.current=projectData.trackIdCounter;}// ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°\nconst validTracks=(projectData.tracks||[]).map(track=>_objectSpread(_objectSpread({},track),{},{clips:(track.clips||[]).filter(clip=>{if(!clip.soundData||!clip.soundData.name){console.warn('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:',clip);return false;}return true;})}));return{tracks:validTracks.length>0?validTracks:[{id:Date.now(),name:'ãƒˆãƒ©ãƒƒã‚¯ 1',clips:[]}],bpm:projectData.bpm||120};}}catch(error){console.error('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:',error);}return{tracks:[{id:Date.now(),name:'ãƒˆãƒ©ãƒƒã‚¯ 1',clips:[]}],bpm:120};};const initialData=loadAutoSavedProject();const[tracks,setTracks]=useState(initialData.tracks);const[bpm,setBpm]=useState(initialData.bpm);const[isPlaying,setIsPlaying]=useState(false);const[currentTime,setCurrentTime]=useState(0);const[audioContext,setAudioContext]=useState(null);const[trackHeight]=useState(80);const[playingAudios,setPlayingAudios]=useState(new Map());const[startPlayTime,setStartPlayTime]=useState(null);const[error,setError]=useState(null);const[sounds,setSounds]=useState([]);const[showSoundPanel,setShowSoundPanel]=useState(true);const[draggedClip,setDraggedClip]=useState(null);const[dragPreview,setDragPreview]=useState(null);const[draggedSoundDuration,setDraggedSoundDuration]=useState(400);// ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®éŸ³ç´ æã®é•·ã•\nconst[dragOffset,setDragOffset]=useState(0);// ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚¯ãƒªãƒƒãƒ—å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆ\nconst[isExporting,setIsExporting]=useState(false);// éŸ³æºå‡ºåŠ›ä¸­ãƒ•ãƒ©ã‚°\nconst timelineRef=useRef(null);const animationFrameRef=useRef(null);const dragOverTimeoutRef=useRef(null);useEffect(()=>{// Web Audio API ã®åˆæœŸåŒ–\nconst ctx=new(window.AudioContext||window.webkitAudioContext)();setAudioContext(ctx);// LocalStorageã‹ã‚‰éŸ³ç´ æã‚’èª­ã¿è¾¼ã¿\nconst savedSounds=JSON.parse(localStorage.getItem('soundRecordings')||'[]');console.log('LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚“ã éŸ³ç´ ææ•°:',savedSounds.length);// audioDataã‹ã‚‰Blobã‚’å¾©å…ƒ\nconst soundsWithBlob=savedSounds.map(sound=>{if(sound.audioData){try{console.log('éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒä¸­:',sound.name,'ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:',sound.audioData.length);// Base64ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼\nif(!sound.audioData.includes(',')){console.error('ç„¡åŠ¹ãªBase64ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:',sound.name);return sound;}const base64Data=sound.audioData.split(',')[1];if(!base64Data||base64Data.length===0){console.error('Base64ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™:',sound.name);return sound;}const byteCharacters=atob(base64Data);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}const byteArray=new Uint8Array(byteNumbers);// Blobã‚µã‚¤ã‚ºã®æ¤œè¨¼\nif(byteArray.length===0){console.error('Blobãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™:',sound.name);return sound;}const blob=new Blob([byteArray],{type:'audio/wav'});console.log('Blobå¾©å…ƒæˆåŠŸ:',sound.name,'ã‚µã‚¤ã‚º:',blob.size,'ã‚¿ã‚¤ãƒ—:',blob.type);// Blobã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª\nif(blob.size===0){console.error('ä½œæˆã•ã‚ŒãŸBlobã®ã‚µã‚¤ã‚ºãŒ0ã§ã™:',sound.name);return sound;}return _objectSpread(_objectSpread({},sound),{},{audioBlob:blob});}catch(error){console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:',sound.name,error);return sound;}}return sound;});// æœ‰åŠ¹ãªéŸ³ç´ æã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°\nconst validSounds=soundsWithBlob.filter(sound=>{if(!sound.audioBlob){console.warn('audioBlobãŒå­˜åœ¨ã—ãªã„éŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:',sound.name);return false;}if(!(sound.audioBlob instanceof Blob)){console.warn('ç„¡åŠ¹ãªBlobå½¢å¼ã®éŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:',sound.name);return false;}if(sound.audioBlob.size===0){console.warn('ã‚µã‚¤ã‚ºãŒ0ã®BlobéŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:',sound.name);return false;}return true;});console.log('æœ‰åŠ¹ãªéŸ³ç´ ææ•°:',validSounds.length,'/ ç·æ•°:',soundsWithBlob.length);setSounds(validSounds);// ç„¡åŠ¹ãªéŸ³ç´ æãŒã‚ã£ãŸå ´åˆã¯LocalStorageã‚’æ›´æ–°\nif(validSounds.length!==soundsWithBlob.length){console.log('ç„¡åŠ¹ãªéŸ³ç´ æã‚’é™¤å»ã—ã¦LocalStorageã‚’æ›´æ–°');const validSoundsForStorage=validSounds.map(sound=>_objectSpread(_objectSpread({},sound),{},{audioBlob:undefined// Blobã¯ä¿å­˜ã—ãªã„\n}));localStorage.setItem('soundRecordings',JSON.stringify(validSoundsForStorage));}return()=>{if(ctx&&ctx.state!=='closed'){ctx.close().catch(error=>{console.warn('åˆæœŸAudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:',error);});}if(animationFrameRef.current){cancelAnimationFrame(animationFrameRef.current);}if(dragOverTimeoutRef.current){clearTimeout(dragOverTimeoutRef.current);}// å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ã™ã¹ã¦åœæ­¢ãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n// useEffectå†…ã§playingAudiosã®æœ€æ–°å€¤ã‚’å–å¾—\nsetPlayingAudios(currentPlayingAudios=>{currentPlayingAudios.forEach(_ref=>{let{audio,timeoutId,audioUrl}=_ref;if(timeoutId){clearTimeout(timeoutId);}if(audio){audio.pause();audio.src='';}if(audioUrl){URL.revokeObjectURL(audioUrl);}});return new Map();// ç©ºã®Mapã‚’è¿”ã™\n});// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nif(window.currentDraggedSoundBlob){window.currentDraggedSoundBlob=null;}if(window.currentDraggedSound){window.currentDraggedSound=null;}};},[]);// éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¶™ç¶šæ™‚é–“ã‚’å–å¾—ã—ã¦ãƒ”ã‚¯ã‚»ãƒ«å¹…ã«å¤‰æ›\nconst getAudioDuration=useCallback(function(audioBlob){let currentBpm=arguments.length>1&&arguments[1]!==undefined?arguments[1]:bpm;return new Promise(async resolve=>{if(!audioBlob||!(audioBlob instanceof Blob)){console.log('ç„¡åŠ¹ãªaudioBlob - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');resolve(400);return;}console.log('audioBlobè©³ç´°:',{size:audioBlob.size,type:audioBlob.type,bpm:currentBpm});// AudioContextã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã‚’å„ªå…ˆ\nif(audioContext){try{console.log('AudioContextæ–¹å¼ã§éŸ³å£°é•·ã•ã‚’å–å¾—ä¸­...');const arrayBuffer=await audioBlob.arrayBuffer();const audioBuffer=await audioContext.decodeAudioData(arrayBuffer);const durationInSeconds=audioBuffer.duration;console.log('AudioContextæ–¹å¼ã§å–å¾—ã—ãŸé•·ã•:',durationInSeconds,'ç§’');if(isFinite(durationInSeconds)&&durationInSeconds>0){const pixelsPerSecond=currentBpm/60*100;const widthInPixels=durationInSeconds*pixelsPerSecond;console.log('AudioContextè¨ˆç®—çµæœ - BPM:',currentBpm,'æ‹/ç§’:',currentBpm/60,'ãƒ”ã‚¯ã‚»ãƒ«/ç§’:',pixelsPerSecond,'æœ€çµ‚å¹…:',widthInPixels,'px');resolve(widthInPixels);return;}}catch(error){console.log('AudioContextæ–¹å¼ã§ã‚¨ãƒ©ãƒ¼:',error);}}// AudioContextãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨\nconsole.log('AudioContextãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');resolve(400);});},[audioContext,bpm]);// ãƒ—ãƒ¬ã‚¤ãƒ˜ãƒƒãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°\nconst updatePlayhead=useCallback(()=>{const animate=()=>{if(isPlaying&&startPlayTime){const elapsed=(Date.now()-startPlayTime)/1000;// çµŒéæ™‚é–“ï¼ˆç§’ï¼‰\nconst pixelsPerSecond=bpm/60*100;// BPMã«åŸºã¥ã„ãŸãƒ”ã‚¯ã‚»ãƒ«/ç§’\nconst newCurrentTime=elapsed*pixelsPerSecond;// æœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\nif(isFinite(newCurrentTime)&&newCurrentTime>=0){setCurrentTime(newCurrentTime);}else{console.warn('ç„¡åŠ¹ãªcurrentTime:',newCurrentTime,'elapsed:',elapsed,'pixelsPerSecond:',pixelsPerSecond);}// æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¦æ±‚\nanimationFrameRef.current=requestAnimationFrame(animate);}};if(isPlaying&&startPlayTime){animate();}},[isPlaying,startPlayTime,bpm]);useEffect(()=>{if(isPlaying){if(!startPlayTime){// å†ç”Ÿé–‹å§‹æ™‚ã«startPlayTimeã‚’è¨­å®š\nconst pixelsPerSecond=bpm/60*100;if(isFinite(pixelsPerSecond)&&pixelsPerSecond>0){const timeInSeconds=currentTime/pixelsPerSecond;if(isFinite(timeInSeconds)&&timeInSeconds>=0){setStartPlayTime(Date.now()-timeInSeconds*1000);}else{setStartPlayTime(Date.now());}}else{setStartPlayTime(Date.now());}}}else{// å†ç”Ÿåœæ­¢æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢\nif(animationFrameRef.current){cancelAnimationFrame(animationFrameRef.current);animationFrameRef.current=null;}setStartPlayTime(null);}// eslint-disable-next-line react-hooks/exhaustive-deps\n},[isPlaying,bpm,currentTime]);// startPlayTimeãŒè¨­å®šã•ã‚ŒãŸã¨ãã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹\nuseEffect(()=>{if(isPlaying&&startPlayTime){updatePlayhead();}},[isPlaying,startPlayTime,updatePlayhead]);// BPMå¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼\nconst handleBpmChange=useCallback(async newBpm=>{setBpm(newBpm);// æ—¢å­˜ã®ã‚¯ãƒªãƒƒãƒ—ã®durationã‚’æ–°ã—ã„BPMã§å†è¨ˆç®—\nconst updatedTracks=await Promise.all(tracks.map(async track=>{const updatedClips=await Promise.all(track.clips.map(async clip=>{if(clip.soundData&&clip.soundData.audioBlob){try{const newDuration=await getAudioDuration(clip.soundData.audioBlob,newBpm);return _objectSpread(_objectSpread({},clip),{},{duration:newDuration});}catch(error){console.warn('ã‚¯ãƒªãƒƒãƒ—ã®durationæ›´æ–°ã«å¤±æ•—:',error);return clip;}}return clip;}));return _objectSpread(_objectSpread({},track),{},{clips:updatedClips});}));setTracks(updatedTracks);},[tracks,getAudioDuration]);// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜æ©Ÿèƒ½\nconst saveProject=()=>{try{const projectData={version:'1.0',bpm:bpm,tracks:tracks,sounds:sounds.map(sound=>_objectSpread(_objectSpread({},sound),{},{audioBlob:null,// Blobã¯åˆ¥é€”ä¿å­˜\naudioData:sound.audioData// base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ\n})),timestamp:Date.now(),trackNameCounter:trackNameCounterRef.current,trackIdCounter:trackIdCounterRef.current};const projectJson=JSON.stringify(projectData,null,2);const blob=new Blob([projectJson],{type:'application/json'});const url=URL.createObjectURL(blob);const link=document.createElement('a');link.href=url;link.download=\"music-project-\".concat(new Date().toISOString().slice(0,19).replace(/:/g,'-'),\".json\");document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');}catch(error){console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:',error);setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');}};// ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿æ©Ÿèƒ½\nconst loadProject=event=>{const file=event.target.files[0];if(!file)return;const reader=new FileReader();reader.onload=e=>{try{const projectData=JSON.parse(e.target.result);// ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯\nif(!projectData.version){throw new Error('ä¸æ­£ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');}// éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°\nconst restoreAudioBlob=soundData=>{if(soundData&&soundData.audioData){try{const byteCharacters=atob(soundData.audioData.split(',')[1]);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}const byteArray=new Uint8Array(byteNumbers);const blob=new Blob([byteArray],{type:'audio/wav'});return _objectSpread(_objectSpread({},soundData),{},{audioBlob:blob});}catch(error){console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:',soundData.name||'unknown',error);return soundData;}}return soundData;};// BPMã‚’å¾©å…ƒ\nsetBpm(projectData.bpm||120);// ãƒˆãƒ©ãƒƒã‚¯ã‚’å¾©å…ƒï¼ˆã‚¯ãƒªãƒƒãƒ—å†…ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚‚å¾©å…ƒï¼‰\nif(projectData.tracks){const restoredTracks=projectData.tracks.map(track=>_objectSpread(_objectSpread({},track),{},{clips:track.clips.map(clip=>_objectSpread(_objectSpread({},clip),{},{soundData:restoreAudioBlob(clip.soundData)})).filter(clip=>{// ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–\nif(!clip.soundData||!clip.soundData.name){console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:',clip);return false;}return true;})}));setTracks(restoredTracks);console.log('ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ:',restoredTracks.length,'ãƒˆãƒ©ãƒƒã‚¯');}// ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¾©å…ƒ\nif(projectData.trackNameCounter){trackNameCounterRef.current=projectData.trackNameCounter;}if(projectData.trackIdCounter){trackIdCounterRef.current=projectData.trackIdCounter;}// éŸ³ç´ æã‚’å¾©å…ƒï¼ˆæ—¢å­˜ã®éŸ³ç´ æã«è¿½åŠ ï¼‰\nif(projectData.sounds){const restoredSounds=projectData.sounds.map(sound=>restoreAudioBlob(sound));// æ—¢å­˜ã®éŸ³ç´ æã¨èª­ã¿è¾¼ã‚“ã éŸ³ç´ æã‚’çµåˆ\nsetSounds(prevSounds=>{const maxId=prevSounds.length>0?Math.max(...prevSounds.map(s=>s.id)):0;const existingNames=new Set(prevSounds.map(s=>s.name));const newSounds=restoredSounds.map((sound,index)=>{let newName=sound.name;let counter=1;// åå‰ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€é‡è¤‡ã™ã‚‹å ´åˆã¯ç•ªå·ã‚’ä»˜ã‘ã‚‹\nwhile(existingNames.has(newName)){newName=\"\".concat(sound.name,\" (\").concat(counter,\")\");counter++;}existingNames.add(newName);return _objectSpread(_objectSpread({},sound),{},{id:maxId+index+1,// æ–°ã—ã„IDã‚’å‰²ã‚Šå½“ã¦\nname:newName// é‡è¤‡ã—ãªã„åå‰ã‚’è¨­å®š\n});});console.log('éŸ³ç´ æã‚’è¿½åŠ ã—ã¾ã—ãŸ:',newSounds.length,'å€‹ï¼ˆæ—¢å­˜:',prevSounds.length,'å€‹ï¼‰');return[...prevSounds,...newSounds];});}console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');setError(null);// èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°\nsetTimeout(()=>{const autoSaveData={version:'1.0',bpm:projectData.bpm||120,tracks:projectData.tracks||[],timestamp:Date.now(),trackNameCounter:projectData.trackNameCounter||1,trackIdCounter:projectData.trackIdCounter||1};localStorage.setItem('dawProjectAutoSave',JSON.stringify(autoSaveData));console.log('èª­ã¿è¾¼ã¿å¾Œã®è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');},100);}catch(error){console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:',error);setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');}};reader.readAsText(file);// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ\nevent.target.value='';};// éŸ³æºå‡ºåŠ›æ©Ÿèƒ½\nconst exportAudio=async()=>{if(!audioContext){setError('AudioContextãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');return;}setIsExporting(true);try{// å…¨ãƒˆãƒ©ãƒƒã‚¯ã®å…¨ã‚¯ãƒªãƒƒãƒ—ã®æœ€å¤§çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—\nlet maxDuration=0;tracks.forEach(track=>{track.clips.forEach(clip=>{const pixelsPerSecond=bpm/60*100;const clipStartTimeInSeconds=clip.startTime/pixelsPerSecond;const clipDurationInSeconds=clip.duration/pixelsPerSecond;const clipEndTime=clipStartTimeInSeconds+clipDurationInSeconds;maxDuration=Math.max(maxDuration,clipEndTime);});});if(maxDuration===0){setError('å‡ºåŠ›ã™ã‚‹éŸ³å£°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚éŸ³ç´ æã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚');setIsExporting(false);return;}// å‡ºåŠ›ç”¨AudioContextã‚’ä½œæˆï¼ˆ44.1kHzï¼‰\nconst exportContext=new AudioContext({sampleRate:44100});const bufferLength=Math.ceil(maxDuration*exportContext.sampleRate);const outputBuffer=exportContext.createBuffer(2,bufferLength,exportContext.sampleRate);const leftChannel=outputBuffer.getChannelData(0);const rightChannel=outputBuffer.getChannelData(1);// å„ãƒˆãƒ©ãƒƒã‚¯ã®å„ã‚¯ãƒªãƒƒãƒ—ã‚’å‡¦ç†\nfor(const track of tracks){for(const clip of track.clips){if(clip.soundData&&clip.soundData.audioBlob){try{const arrayBuffer=await clip.soundData.audioBlob.arrayBuffer();const audioBuffer=await exportContext.decodeAudioData(arrayBuffer);const pixelsPerSecond=bpm/60*100;const startTimeInSamples=Math.floor(clip.startTime/pixelsPerSecond*exportContext.sampleRate);// éŸ³å£°ã‚’ãƒŸãƒƒã‚¯ã‚¹\nfor(let channel=0;channel<Math.min(audioBuffer.numberOfChannels,2);channel++){const sourceData=audioBuffer.getChannelData(channel);const targetData=channel===0?leftChannel:rightChannel;for(let i=0;i<sourceData.length&&startTimeInSamples+i<targetData.length;i++){targetData[startTimeInSamples+i]+=sourceData[i];}}// ãƒ¢ãƒãƒ©ãƒ«éŸ³æºã®å ´åˆã¯ä¸¡ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚³ãƒ”ãƒ¼\nif(audioBuffer.numberOfChannels===1){const sourceData=audioBuffer.getChannelData(0);for(let i=0;i<sourceData.length&&startTimeInSamples+i<rightChannel.length;i++){rightChannel[startTimeInSamples+i]+=sourceData[i];}}}catch(error){console.error('ã‚¯ãƒªãƒƒãƒ—ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:',error);}}}}// WAVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›\nconst wavBlob=audioBufferToWav(outputBuffer);const url=URL.createObjectURL(wavBlob);const link=document.createElement('a');link.href=url;link.download=\"exported-music-\".concat(new Date().toISOString().slice(0,19).replace(/:/g,'-'),\".wav\");document.body.appendChild(link);link.click();document.body.removeChild(link);URL.revokeObjectURL(url);console.log('éŸ³æºã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');if(exportContext&&exportContext.state!=='closed'){await exportContext.close().catch(error=>{console.warn('Export AudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:',error);});}}catch(error){console.error('éŸ³æºå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:',error);setError('éŸ³æºã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');}finally{setIsExporting(false);}};// AudioBufferã‚’WAVãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›\nconst audioBufferToWav=buffer=>{const length=buffer.length;const numberOfChannels=buffer.numberOfChannels;const sampleRate=buffer.sampleRate;const bytesPerSample=2;const blockAlign=numberOfChannels*bytesPerSample;const byteRate=sampleRate*blockAlign;const dataSize=length*blockAlign;const bufferSize=44+dataSize;const arrayBuffer=new ArrayBuffer(bufferSize);const view=new DataView(arrayBuffer);// WAVãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼\nconst writeString=(offset,string)=>{for(let i=0;i<string.length;i++){view.setUint8(offset+i,string.charCodeAt(i));}};writeString(0,'RIFF');view.setUint32(4,bufferSize-8,true);writeString(8,'WAVE');writeString(12,'fmt ');view.setUint32(16,16,true);view.setUint16(20,1,true);view.setUint16(22,numberOfChannels,true);view.setUint32(24,sampleRate,true);view.setUint32(28,byteRate,true);view.setUint16(32,blockAlign,true);view.setUint16(34,bytesPerSample*8,true);writeString(36,'data');view.setUint32(40,dataSize,true);// éŸ³å£°ãƒ‡ãƒ¼ã‚¿\nlet offset=44;for(let i=0;i<length;i++){for(let channel=0;channel<numberOfChannels;channel++){const sample=buffer.getChannelData(channel)[i];const intSample=Math.max(-1,Math.min(1,sample))*0x7FFF;view.setInt16(offset,intSample,true);offset+=2;}}return new Blob([arrayBuffer],{type:'audio/wav'});};const addTrack=()=>{// ã‚ˆã‚Šç¢ºå®Ÿã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ\ntrackIdCounterRef.current+=1;const uniqueId=Date.now()+trackIdCounterRef.current;// ãƒˆãƒ©ãƒƒã‚¯åã®ç•ªå·ã‚’å¢—åŠ ï¼ˆå‰Šé™¤ã•ã‚Œã¦ã‚‚ç•ªå·ã¯æˆ»ã‚‰ãªã„ï¼‰\ntrackNameCounterRef.current+=1;const trackName=\"\\u30C8\\u30E9\\u30C3\\u30AF \".concat(trackNameCounterRef.current);const newTrack={id:uniqueId,name:trackName,clips:[]};setTracks(prevTracks=>[...prevTracks,newTrack]);};const removeTrack=trackId=>{setTracks(prevTracks=>{if(prevTracks.length>1){return prevTracks.filter(track=>track.id!==trackId);}return prevTracks;});};const handleDrop=async(e,trackId,timePosition)=>{e.preventDefault();setDragPreview(null);console.log('ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†é–‹å§‹:',{trackId,timePosition,draggedClip});try{// æ—¢å­˜ã®ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯\nif(draggedClip){console.log('æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•:',draggedClip.id,'å…ƒãƒˆãƒ©ãƒƒã‚¯:',draggedClip.originalTrackId,'æ–°ãƒˆãƒ©ãƒƒã‚¯:',trackId);console.log('ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆ:',dragOffset,'ãƒã‚¦ã‚¹ä½ç½®:',timePosition);// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ã—ãŸæ–°ã—ã„é–‹å§‹ä½ç½®ã‚’è¨ˆç®—\nconst adjustedPosition=timePosition-dragOffset;// 8åˆ†éŸ³ç¬¦ã«åˆã‚ã›ã¦ä½ç½®ã‚’èª¿æ•´ï¼ˆ50pxå˜ä½ï¼‰\nconst snappedPosition=Math.max(0,Math.round(adjustedPosition/SUB_BEAT_WIDTH)*SUB_BEAT_WIDTH);console.log('èª¿æ•´å¾Œã®ä½ç½®:',adjustedPosition,'ã‚¹ãƒŠãƒƒãƒ—å¾Œ:',snappedPosition);// æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•\nconst updatedClip=_objectSpread(_objectSpread({},draggedClip),{},{startTime:snappedPosition,trackId:trackId});setTracks(prevTracks=>prevTracks.map(track=>{if(track.id===draggedClip.originalTrackId&&track.id===trackId){// åŒã˜ãƒˆãƒ©ãƒƒã‚¯å†…ã§ã®ç§»å‹•\nconsole.log('åŒã˜ãƒˆãƒ©ãƒƒã‚¯å†…ã§ã®ç§»å‹•');return _objectSpread(_objectSpread({},track),{},{clips:track.clips.map(clip=>clip.id===draggedClip.id?updatedClip:clip)});}else if(track.id===draggedClip.originalTrackId){// å…ƒã®ãƒˆãƒ©ãƒƒã‚¯ã‹ã‚‰ã‚¯ãƒªãƒƒãƒ—ã‚’å‰Šé™¤\nconsole.log('å…ƒã®ãƒˆãƒ©ãƒƒã‚¯ã‹ã‚‰ã‚¯ãƒªãƒƒãƒ—ã‚’å‰Šé™¤');return _objectSpread(_objectSpread({},track),{},{clips:track.clips.filter(clip=>clip.id!==draggedClip.id)});}else if(track.id===trackId){// æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã«ã‚¯ãƒªãƒƒãƒ—ã‚’è¿½åŠ \nconsole.log('æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã«ã‚¯ãƒªãƒƒãƒ—ã‚’è¿½åŠ ');return _objectSpread(_objectSpread({},track),{},{clips:[...track.clips,updatedClip]});}return track;}));setDraggedClip(null);setDragOffset(0);return;}// æ–°ã—ã„éŸ³ç´ æã®é…ç½®\nlet soundData;try{// dataTransferã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\nconst jsonData=e.dataTransfer?e.dataTransfer.getData('application/json'):'';if(jsonData){soundData=JSON.parse(jsonData);}else{// ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰å–å¾—\nsoundData=window.currentDraggedSound;}}catch(error){console.error('ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:',error);soundData=window.currentDraggedSound;// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯\n}if(!soundData){console.error('éŸ³ç´ æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');setError('éŸ³ç´ æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');return;}// soundDataã®å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒã‚§ãƒƒã‚¯\nif(!soundData.name){console.error('éŸ³ç´ æã®åå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:',soundData);setError('éŸ³ç´ æã®åå‰ãŒä¸æ­£ã§ã™ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');return;}// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰audioBlobã‚’å¾©å…ƒ\nif(window.currentDraggedSoundBlob){soundData.audioBlob=window.currentDraggedSoundBlob;window.currentDraggedSoundBlob=null;// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n}// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢\nwindow.currentDraggedSound=null;console.log('æ–°ã—ã„éŸ³ç´ æã®ãƒ‰ãƒ­ãƒƒãƒ—:',{soundData,hasAudioBlob:!!soundData.audioBlob});// éŸ³å£°ã®å®Ÿéš›ã®ç¶™ç¶šæ™‚é–“ã‚’å–å¾—ï¼ˆç¾åœ¨ã®BPMã«åŸºã¥ã„ã¦ï¼‰\nlet duration=400;// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ1å°ç¯€ï¼‰\nif(soundData.audioBlob){try{duration=await getAudioDuration(soundData.audioBlob,bpm);console.log('å–å¾—ã—ãŸduration:',duration,'pixels (BPM:',bpm,')');}catch(error){console.warn('éŸ³å£°ç¶™ç¶šæ™‚é–“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:',error);}}// durationãŒæœ‰åŠ¹ãªå€¤ã‹ãƒã‚§ãƒƒã‚¯\nif(!isFinite(duration)||duration<=0){console.warn('ç„¡åŠ¹ãªduration:',duration,'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');duration=400;// 1å°ç¯€åˆ†\n}// æ–°ã—ã„éŸ³ç´ æã®å ´åˆã¯é€šå¸¸ã®ã‚¹ãƒŠãƒƒãƒ—å‡¦ç†\nconst snappedPosition=Math.round(timePosition/SUB_BEAT_WIDTH)*SUB_BEAT_WIDTH;const newClip={id:Date.now()+Math.random(),// ã‚ˆã‚Šç¢ºå®Ÿã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ\nsoundData:soundData,startTime:snappedPosition,duration:duration,trackId:trackId};console.log('ä½œæˆã•ã‚ŒãŸã‚¯ãƒªãƒƒãƒ—:',newClip);console.log('ç¾åœ¨ã®ãƒˆãƒ©ãƒƒã‚¯æ•°:',tracks.length);console.log('å¯¾è±¡ãƒˆãƒ©ãƒƒã‚¯ID:',trackId);console.log('å¯¾è±¡ãƒˆãƒ©ãƒƒã‚¯:',tracks.find(t=>t.id===trackId));// é–¢æ•°å‹æ›´æ–°ã‚’ä½¿ç”¨ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«å–å¾—\nsetTracks(prevTracks=>{console.log('æ›´æ–°å‰ã®ãƒˆãƒ©ãƒƒã‚¯:',prevTracks.find(t=>t.id===trackId));const updatedTracks=prevTracks.map(track=>track.id===trackId?_objectSpread(_objectSpread({},track),{},{clips:[...track.clips,newClip]}):track);console.log('æ›´æ–°å¾Œã®ãƒˆãƒ©ãƒƒã‚¯:',updatedTracks.find(t=>t.id===trackId));return updatedTracks;});}catch(error){console.error('ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:',error);setError('éŸ³ç´ æã®é…ç½®ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');}};const handleDragOver=e=>{e.preventDefault();// ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œã¦ã„ã‚‹ã®ãŒæ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã‹æ–°ã—ã„éŸ³ç´ æã‹ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹\nif(draggedClip){e.dataTransfer.dropEffect='move';}else{e.dataTransfer.dropEffect='copy';}// ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚° - 16msï¼ˆ60FPSï¼‰é–“éš”ã§å®Ÿè¡Œã‚’åˆ¶é™\nif(dragOverTimeoutRef.current){return;}// å¿…è¦ãªæƒ…å ±ã‚’äº‹å‰ã«æŠ½å‡º\nconst clientX=e.clientX;const currentTarget=e.currentTarget;dragOverTimeoutRef.current=setTimeout(()=>{dragOverTimeoutRef.current=null;updateDragPreview(clientX,currentTarget);},16);};const updateDragPreview=(clientX,trackElement)=>{// null ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ \nif(!trackElement||!timelineRef.current){return;}// åˆå›ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã«å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š\nif(!window.dragCleanupTimer){console.log('å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼è¨­å®šï¼ˆ10ç§’å¾Œï¼‰');window.dragCleanupTimer=setTimeout(()=>{console.log('å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œ');cleanupDragState();},10000);// 10ç§’å¾Œã«å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n}try{// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°\nconst rect=trackElement.getBoundingClientRect();const timePosition=clientX-rect.left;let snappedPosition;if(draggedClip){// æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®å ´åˆï¼šãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®\nconst adjustedPosition=timePosition-dragOffset;snappedPosition=Math.max(0,Math.round(adjustedPosition/SUB_BEAT_WIDTH)*SUB_BEAT_WIDTH);}else{// æ–°ã—ã„éŸ³ç´ æã®å ´åˆï¼šé€šå¸¸ã®å‡¦ç†\nsnappedPosition=Math.round(timePosition/SUB_BEAT_WIDTH)*SUB_BEAT_WIDTH;}const trackRect=trackElement.getBoundingClientRect();const tracksAreaRect=timelineRef.current.getBoundingClientRect();if(tracksAreaRect&&trackElement.dataset&&trackElement.dataset.trackId){const relativeTop=trackRect.top-tracksAreaRect.top;const trackId=parseInt(trackElement.dataset.trackId);// trackIdãŒæœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\nif(isNaN(trackId)){return;}// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹…ã‚’æ±ºå®š\nlet previewWidth=400;// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ1å°ç¯€ï¼‰\nif(draggedClip){// æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®å ´åˆ\npreviewWidth=isFinite(draggedClip.duration)&&draggedClip.duration>0?draggedClip.duration:400;}else{// æ–°ã—ã„éŸ³ç´ æã®å ´åˆã€äº‹å‰ã«è¨ˆç®—ã•ã‚ŒãŸé•·ã•ã‚’ä½¿ç”¨\npreviewWidth=draggedSoundDuration;}setDragPreview({left:snappedPosition,top:relativeTop+10,width:previewWidth,trackId:trackId});}}catch(error){console.warn('ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:',error);// ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢\nsetDragPreview(null);}};const removeClip=(trackId,clipId)=>{setTracks(prevTracks=>prevTracks.map(track=>track.id===trackId?_objectSpread(_objectSpread({},track),{},{clips:track.clips.filter(clip=>clip.id!==clipId)}):track));};// ã‚¯ãƒªãƒƒãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹\nconst handleClipDragStart=(clip,originalTrackId,mouseX,clipElement)=>{console.log('ã‚¯ãƒªãƒƒãƒ—ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:',clip.id,'ãƒˆãƒ©ãƒƒã‚¯:',originalTrackId);// ã‚¯ãƒªãƒƒãƒ—å†…ã§ã®ãƒã‚¦ã‚¹ä½ç½®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—\nconst clipRect=clipElement.getBoundingClientRect();const offsetInClip=mouseX-clipRect.left;console.log('ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆ:',offsetInClip,'ã‚¯ãƒªãƒƒãƒ—é–‹å§‹ä½ç½®:',clip.startTime);setDraggedClip(_objectSpread(_objectSpread({},clip),{},{originalTrackId}));setDragOffset(offsetInClip);};// ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®å®Œå…¨ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nconst cleanupDragState=useCallback(()=>{console.log('ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ');// ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢\nif(dragOverTimeoutRef.current){clearTimeout(dragOverTimeoutRef.current);dragOverTimeoutRef.current=null;}// å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢\nif(window.dragCleanupTimer){clearTimeout(window.dragCleanupTimer);window.dragCleanupTimer=null;}// ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°é–¢é€£ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ\nsetDraggedClip(null);setDragPreview(null);setDraggedSoundDuration(400);setDragOffset(0);// DOMè¦ç´ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\ndocument.querySelectorAll('.track').forEach(track=>{track.classList.remove('drag-over');});// ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤\nconst mobileDragPreview=document.querySelector('.mobile-drag-preview');if(mobileDragPreview){mobileDragPreview.remove();}// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nif(window.currentDraggedSoundBlob){window.currentDraggedSoundBlob=null;}if(window.currentDraggedSound){window.currentDraggedSound=null;}// ãƒœãƒ‡ã‚£ã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\ndocument.body.classList.remove('dragging');},[]);// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š\nuseEffect(()=>{window.cleanupDragStateCallback=cleanupDragState;// ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ \nconst handleGlobalDragEnd=()=>{console.log('ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡º');cleanupDragState();};const handleGlobalDragLeave=e=>{// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤–ã«ãƒ‰ãƒ©ãƒƒã‚°ãŒå‡ºãŸå ´åˆ\nif(!e.relatedTarget||e.relatedTarget.nodeName==='HTML'){console.log('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤–ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¦ãƒˆ');cleanupDragState();}};// ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š\ndocument.addEventListener('dragend',handleGlobalDragEnd);document.addEventListener('dragleave',handleGlobalDragLeave);// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°\nreturn()=>{if(window.cleanupDragStateCallback===cleanupDragState){window.cleanupDragStateCallback=null;}document.removeEventListener('dragend',handleGlobalDragEnd);document.removeEventListener('dragleave',handleGlobalDragLeave);};},[cleanupDragState]);// ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nconst handleDragEnd=e=>{// ãƒ‰ãƒ­ãƒƒãƒ—ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œãªã‹ã£ãŸå ´åˆã€å…ƒã®çŠ¶æ…‹ã‚’ä¿æŒ\nif(draggedClip&&e&&e.dataTransfer&&e.dataTransfer.dropEffect==='none'){console.log('ãƒ‰ãƒ©ãƒƒã‚°ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚å…ƒã®ä½ç½®ã‚’ä¿æŒã—ã¾ã™ã€‚');}// å®Œå…¨ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\ncleanupDragState();};const play=async()=>{try{// AudioContextãŒä¸­æ–­ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†é–‹\nif(audioContext&&audioContext.state==='suspended'){await audioContext.resume();}setIsPlaying(true);// ç¾åœ¨ã®æ™‚é–“ä½ç½®ã«åŸºã¥ã„ã¦ã€å†ç”Ÿã™ã¹ãã‚¯ãƒªãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã‚‹\nconst pixelsPerSecond=bpm/60*100;const currentTimeInSeconds=currentTime/pixelsPerSecond;// å„ãƒˆãƒ©ãƒƒã‚¯ã®ã‚¯ãƒªãƒƒãƒ—ã‚’å†ç”Ÿ\nconst newPlayingAudios=new Map();tracks.forEach(track=>{track.clips.forEach(clip=>{// clip.durationãŒæœ‰åŠ¹ãªå€¤ã‹ãƒã‚§ãƒƒã‚¯\nif(!isFinite(clip.duration)||clip.duration<=0){console.warn('ç„¡åŠ¹ãªclip.duration:',clip.duration,'ã‚¯ãƒªãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');return;}const clipStartTimeInSeconds=clip.startTime/pixelsPerSecond;const clipEndTimeInSeconds=clipStartTimeInSeconds+clip.duration/pixelsPerSecond;// è¨ˆç®—çµæœãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯\nif(!isFinite(clipStartTimeInSeconds)||!isFinite(clipEndTimeInSeconds)){console.warn('ç„¡åŠ¹ãªæ™‚é–“è¨ˆç®—:',{clipStartTimeInSeconds,clipEndTimeInSeconds});return;}// ç¾åœ¨ã®æ™‚é–“ä½ç½®ãŒã‚¯ãƒªãƒƒãƒ—ã®ç¯„å›²å†…ã¾ãŸã¯ä»Šå¾Œå†ç”Ÿã•ã‚Œã‚‹å ´åˆ\nif(clipEndTimeInSeconds>currentTimeInSeconds){const delay=Math.max(0,clipStartTimeInSeconds-currentTimeInSeconds);if(isFinite(delay)&&delay>=0){scheduleClipPlayback(clip,delay*1000,newPlayingAudios);}}});});setPlayingAudios(newPlayingAudios);}catch(error){console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:',error);setError('éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³å£°ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');}};const scheduleClipPlayback=(clip,delayMs,playingAudiosMap)=>{var _clip$soundData;console.log('scheduleClipPlayback:',{clip,hasAudioBlob:!!((_clip$soundData=clip.soundData)!==null&&_clip$soundData!==void 0&&_clip$soundData.audioBlob)});if(clip.soundData&&clip.soundData.audioBlob&&clip.soundData.audioBlob instanceof Blob){try{const audio=new Audio();const audioUrl=URL.createObjectURL(clip.soundData.audioBlob);audio.src=audioUrl;const timeoutId=setTimeout(()=>{audio.play().catch(error=>{console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:',error);URL.revokeObjectURL(audioUrl);// ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ã\n});},delayMs);// éŸ³å£°çµ‚äº†æ™‚ã«URLã‚’è§£æ”¾\naudio.addEventListener('ended',()=>{URL.revokeObjectURL(audioUrl);});playingAudiosMap.set(clip.id,{audio,timeoutId,audioUrl});}catch(error){console.error('createObjectURL ã‚¨ãƒ©ãƒ¼:',error,'audioBlob:',clip.soundData.audioBlob);}}else{var _clip$soundData2,_clip$soundData3,_clip$soundData4,_clip$soundData5,_clip$soundData6;console.warn('audioBlobãŒç„¡åŠ¹ã§ã™ã€‚ã‚¯ãƒªãƒƒãƒ—æƒ…å ±:',{clipId:clip.id,soundDataName:(_clip$soundData2=clip.soundData)===null||_clip$soundData2===void 0?void 0:_clip$soundData2.name,hasAudioData:!!((_clip$soundData3=clip.soundData)!==null&&_clip$soundData3!==void 0&&_clip$soundData3.audioData),hasAudioBlob:!!((_clip$soundData4=clip.soundData)!==null&&_clip$soundData4!==void 0&&_clip$soundData4.audioBlob),audioBlobType:typeof((_clip$soundData5=clip.soundData)===null||_clip$soundData5===void 0?void 0:_clip$soundData5.audioBlob),isInstanceOfBlob:((_clip$soundData6=clip.soundData)===null||_clip$soundData6===void 0?void 0:_clip$soundData6.audioBlob)instanceof Blob});// AudioBlobãŒç„¡åŠ¹ãªå ´åˆã€audioDataã‹ã‚‰å¾©å…ƒã‚’è©¦è¡Œ\nif(clip.soundData&&clip.soundData.audioData&&!clip.soundData.audioBlob){console.log('audioDataã‹ã‚‰Blobã‚’å†ä½œæˆä¸­...');try{const byteCharacters=atob(clip.soundData.audioData.split(',')[1]);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}const byteArray=new Uint8Array(byteNumbers);const blob=new Blob([byteArray],{type:'audio/wav'});// ã‚¯ãƒªãƒƒãƒ—ã®soundDataã‚’æ›´æ–°\nclip.soundData.audioBlob=blob;// å†å¸°çš„ã«å†è©¦è¡Œ\nscheduleClipPlayback(clip,delayMs,playingAudiosMap);return;}catch(restoreError){console.error('audioDataã‹ã‚‰ã®Blobå¾©å…ƒã«å¤±æ•—:',restoreError);}}}};const pause=()=>{setIsPlaying(false);// å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ä¸€æ™‚åœæ­¢\nplayingAudios.forEach(_ref2=>{let{audio,timeoutId,audioUrl}=_ref2;if(timeoutId){clearTimeout(timeoutId);}if(!audio.paused){audio.pause();}// URLã‚’è§£æ”¾\nif(audioUrl){URL.revokeObjectURL(audioUrl);}});};const stop=()=>{setIsPlaying(false);setCurrentTime(0);// å†ç”Ÿä¸­ã®éŸ³å£°ã‚’åœæ­¢\nplayingAudios.forEach(_ref3=>{let{audio,timeoutId,audioUrl}=_ref3;if(timeoutId){clearTimeout(timeoutId);}audio.pause();audio.currentTime=0;// URLã‚’è§£æ”¾\nif(audioUrl){URL.revokeObjectURL(audioUrl);}});setPlayingAudios(new Map());};// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜æ©Ÿèƒ½\nuseEffect(()=>{const autoSaveProject=()=>{try{const projectData={version:'1.0',bpm:bpm,tracks:tracks,timestamp:Date.now(),trackNameCounter:trackNameCounterRef.current,trackIdCounter:trackIdCounterRef.current};localStorage.setItem('dawProjectAutoSave',JSON.stringify(projectData));console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ:',{tracksCount:tracks.length,bpm:bpm,totalClips:tracks.reduce((total,track)=>total+track.clips.length,0)});}catch(error){console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—:',error);}};// åˆæœŸåŒ–å¾Œã®è‡ªå‹•ä¿å­˜ï¼ˆtracksã‚„bpmãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ï¼‰\nif(tracks.length>0){autoSaveProject();}},[tracks,bpm]);// éŸ³ç´ æã®æ›´æ–°ç›£è¦–ï¼ˆä»–ã®ãƒšãƒ¼ã‚¸ã§éŸ³ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼‰\nuseEffect(()=>{const handleVisibilityChange=()=>{if(!document.hidden){// ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«éŸ³ç´ æã‚’å†èª­ã¿è¾¼ã¿\nconst savedSounds=JSON.parse(localStorage.getItem('soundRecordings')||'[]');console.log('ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®éŸ³ç´ æå†èª­ã¿è¾¼ã¿ - ä»¶æ•°:',savedSounds.length);// éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ï¼‰\nconst soundsWithBlob=savedSounds.map(sound=>{if(sound.audioData){try{const base64Data=sound.audioData.split(',')[1];if(!base64Data||base64Data.length===0){return sound;}const byteCharacters=atob(base64Data);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}const byteArray=new Uint8Array(byteNumbers);const blob=new Blob([byteArray],{type:'audio/wav'});return _objectSpread(_objectSpread({},sound),{},{audioBlob:blob});}catch(error){console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:',sound.name,error);return sound;}}return sound;});const validSounds=soundsWithBlob.filter(sound=>sound.audioBlob&&sound.audioBlob instanceof Blob&&sound.audioBlob.size>0);setSounds(validSounds);console.log('éŸ³ç´ ææ›´æ–°å®Œäº† - æœ‰åŠ¹ä»¶æ•°:',validSounds.length);}};document.addEventListener('visibilitychange',handleVisibilityChange);return()=>{document.removeEventListener('visibilitychange',handleVisibilityChange);};},[]);// è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹æ©Ÿèƒ½\nconst clearAutoSave=()=>{try{localStorage.removeItem('dawProjectAutoSave');console.log('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');// åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ\nsetTracks([{id:Date.now(),name:'ãƒˆãƒ©ãƒƒã‚¯ 1',clips:[]}]);setBpm(120);trackNameCounterRef.current=1;trackIdCounterRef.current=1;setError(null);alert('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');}catch(error){console.error('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:',error);setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');}};// ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–ã™ã‚‹é–¢æ•°\nconst cleanupInvalidClips=()=>{setTracks(prevTracks=>{const cleanedTracks=prevTracks.map(track=>_objectSpread(_objectSpread({},track),{},{clips:track.clips.filter(clip=>{if(!clip.soundData||!clip.soundData.name){console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:',clip);return false;}return true;})}));const removedCount=prevTracks.reduce((total,track)=>total+track.clips.length,0)-cleanedTracks.reduce((total,track)=>total+track.clips.length,0);if(removedCount>0){console.log(\"\".concat(removedCount,\"\\u500B\\u306E\\u7121\\u52B9\\u306A\\u30AF\\u30EA\\u30C3\\u30D7\\u3092\\u9664\\u5916\\u3057\\u307E\\u3057\\u305F\"));}return cleanedTracks;});};// åˆæœŸåŒ–æ™‚ã«ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nuseEffect(()=>{const timer=setTimeout(()=>{cleanupInvalidClips();},1000);// 1ç§’å¾Œã«å®Ÿè¡Œ\nreturn()=>clearTimeout(timer);},[]);// ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã®åŒ…æ‹¬çš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nuseEffect(()=>{return()=>{// ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\ncleanupDragState();// å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ã™ã¹ã¦åœæ­¢\nsetPlayingAudios(currentPlayingAudios=>{currentPlayingAudios.forEach(_ref4=>{let{audio,timeoutId,audioUrl}=_ref4;if(timeoutId){clearTimeout(timeoutId);}if(audio){audio.pause();audio.src='';}if(audioUrl){URL.revokeObjectURL(audioUrl);}});return new Map();});// AudioContextã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nif(audioContext&&audioContext.state!=='closed'){audioContext.close().catch(error=>{console.warn('AudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:',error);});}// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢\nif(animationFrameRef.current){cancelAnimationFrame(animationFrameRef.current);}// ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢\nif(dragOverTimeoutRef.current){clearTimeout(dragOverTimeoutRef.current);}};},[cleanupDragState,audioContext]);return/*#__PURE__*/_jsxs(\"div\",{className:\"daw-page\",children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\uD83C\\uDFB9 \\u97F3\\u697D\\u3065\\u304F\\u308A\\u30DA\\u30FC\\u30B8\"}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u97F3\\u7D20\\u6750\\u3092\\u30C9\\u30E9\\u30C3\\u30B0&\\u30C9\\u30ED\\u30C3\\u30D7\\u3057\\u3066\\u97F3\\u697D\\u3092\\u4F5C\\u308A\\u307E\\u3057\\u3087\\u3046\\uFF01\"}),error&&/*#__PURE__*/_jsxs(\"div\",{className:\"error-message\",children:[/*#__PURE__*/_jsxs(\"span\",{children:[\"\\u26A0\\uFE0F \",error]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setError(null),children:\"\\xD7\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"daw-controls card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"transport-controls\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"transport-btn play-btn \".concat(isPlaying?'playing':''),onClick:isPlaying?pause:play,children:isPlaying?'â¸ï¸':'â–¶ï¸'}),/*#__PURE__*/_jsx(\"button\",{className:\"transport-btn stop-btn\",onClick:stop,children:\"\\u23F9\\uFE0F\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bpm-control\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"bpm\",children:\"\\uD83C\\uDFB5 BPM:\"}),/*#__PURE__*/_jsx(\"input\",{id:\"bpm\",type:\"number\",value:bpm,onChange:e=>handleBpmChange(parseInt(e.target.value)),min:\"60\",max:\"200\",className:\"bpm-input\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"track-controls\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"button-primary\",onClick:addTrack,children:\"\\u2795 \\u30C8\\u30E9\\u30C3\\u30AF\\u8FFD\\u52A0\"}),/*#__PURE__*/_jsx(\"button\",{className:\"button-secondary\",onClick:()=>setShowSoundPanel(!showSoundPanel),children:showSoundPanel?'ğŸµ éŸ³ç´ æã‚’éš ã™':'ğŸµ éŸ³ç´ æã‚’è¡¨ç¤º'})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"project-controls\",children:[/*#__PURE__*/_jsx(\"button\",{className:\"button-secondary\",onClick:saveProject,children:\"\\uD83D\\uDCBE \\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u4FDD\\u5B58\"}),/*#__PURE__*/_jsxs(\"label\",{className:\"button-secondary file-input-label\",children:[\"\\uD83D\\uDCC1 \\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u8AAD\\u307F\\u8FBC\\u307F\",/*#__PURE__*/_jsx(\"input\",{type:\"file\",accept:\".json\",onChange:loadProject,style:{display:'none'}})]}),/*#__PURE__*/_jsx(\"button\",{className:\"button-warning\",onClick:()=>{if(window.confirm('ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\\n\\nç¾åœ¨ã®ä½œæ¥­å†…å®¹ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')){clearAutoSave();}},title:\"\\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u3092\\u30EA\\u30BB\\u30C3\\u30C8\\uFF08\\u81EA\\u52D5\\u4FDD\\u5B58\\u30C7\\u30FC\\u30BF\\u3082\\u30AF\\u30EA\\u30A2\\uFF09\",children:\"\\uD83D\\uDDD1\\uFE0F \\u30EA\\u30BB\\u30C3\\u30C8\"}),/*#__PURE__*/_jsx(\"button\",{className:\"button-primary\",onClick:exportAudio,disabled:isExporting,children:isExporting?'ğŸ”„ å‡ºåŠ›ä¸­...':'ğŸ§ éŸ³æºå‡ºåŠ›'})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"daw-main-area\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"sound-panel \".concat(!showSoundPanel?'panel-hidden':''),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"sound-panel-header\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83C\\uDFB5 \\u97F3\\u7D20\\u6750\"}),/*#__PURE__*/_jsx(\"button\",{className:\"sound-panel-close\",onClick:()=>setShowSoundPanel(false),title:\"\\u97F3\\u7D20\\u6750\\u30D1\\u30CD\\u30EB\\u3092\\u9589\\u3058\\u308B\",children:\"\\u2715\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"sound-list\",children:sounds.length>0?sounds.map(sound=>/*#__PURE__*/_jsx(SoundItem,{sound:sound,onDragStart:async sound=>{// ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«éŸ³å£°ã®é•·ã•ã‚’è¨ˆç®—\nconsole.log('ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ - éŸ³å£°é•·ã•è¨ˆç®—ä¸­:',sound.name);if(sound.audioBlob){try{const duration=await getAudioDuration(sound.audioBlob,bpm);console.log('è¨ˆç®—ã•ã‚ŒãŸéŸ³å£°é•·ã•:',duration,'px');setDraggedSoundDuration(duration);}catch(error){console.warn('ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®éŸ³å£°é•·ã•è¨ˆç®—ã«å¤±æ•—:',error);setDraggedSoundDuration(400);}}else{console.log('audioBlob ãŒå­˜åœ¨ã—ã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨');setDraggedSoundDuration(400);}}},sound.id)):/*#__PURE__*/_jsxs(\"div\",{className:\"no-sounds\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"\\u97F3\\u7D20\\u6750\\u304C\\u3042\\u308A\\u307E\\u305B\\u3093\"}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u300C\\u97F3\\u3042\\u3064\\u3081\\u300D\\u30DA\\u30FC\\u30B8\\u3067\\u97F3\\u3092\\u9332\\u97F3\\u3057\\u3066\\u304F\\u3060\\u3055\\u3044\"})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"daw-workspace \".concat(!showSoundPanel?'panel-hidden':''),children:[/*#__PURE__*/_jsxs(\"div\",{className:\"track-headers\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"timeline-header-spacer\",children:\"\\u30BF\\u30A4\\u30E0\\u30E9\\u30A4\\u30F3\"}),tracks.map(track=>/*#__PURE__*/_jsx(TrackHeader,{track:track,onRemove:removeTrack,trackHeight:trackHeight},track.id))]}),/*#__PURE__*/_jsxs(\"div\",{className:\"timeline-container\",children:[/*#__PURE__*/_jsx(Timeline,{bpm:bpm}),/*#__PURE__*/_jsxs(\"div\",{className:\"tracks-area\",ref:timelineRef,style:{minWidth:TOTAL_MEASURES*MEASURE_WIDTH},children:[/*#__PURE__*/_jsx(Playhead,{currentTime:currentTime}),dragPreview&&/*#__PURE__*/_jsx(\"div\",{className:\"drag-preview\",style:{left:dragPreview.left,top:dragPreview.top,width:dragPreview.width}}),tracks.map(track=>/*#__PURE__*/_jsx(Track,{track:track,onDrop:handleDrop,onDragOver:handleDragOver,onRemoveClip:removeClip,onClipDragStart:handleClipDragStart,onDragEnd:handleDragEnd,trackHeight:trackHeight,bpm:bpm,updateDragPreview:updateDragPreview},track.id))]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"instructions card\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"\\uD83D\\uDCD6 \\u4F7F\\u3044\\u65B9\"}),/*#__PURE__*/_jsxs(\"ul\",{children:[/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDDA5\\uFE0F PC:\"}),\" \\u5DE6\\u5074\\u306E\\u97F3\\u7D20\\u6750\\u30D1\\u30CD\\u30EB\\u304B\\u3089\\u97F3\\u7D20\\u6750\\u3092\\u30C8\\u30E9\\u30C3\\u30AF\\u306B\\u30C9\\u30E9\\u30C3\\u30B0&\\u30C9\\u30ED\\u30C3\\u30D7\\u3057\\u3066\\u914D\\u7F6E\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDCF1 \\u30B9\\u30DE\\u30DB/\\u30BF\\u30D6\\u30EC\\u30C3\\u30C8:\"}),\" \\u97F3\\u7D20\\u6750\\u3092\\u9577\\u62BC\\u3057\\u3057\\u3066\\u304B\\u3089\\u30C8\\u30E9\\u30C3\\u30AF\\u307E\\u3067\\u30C9\\u30E9\\u30C3\\u30B0\\u3057\\u3066\\u914D\\u7F6E\"]}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u914D\\u7F6E\\u6E08\\u307F\\u306E\\u97F3\\u7D20\\u6750\\u3082\\u30C9\\u30E9\\u30C3\\u30B0\\u3057\\u3066\\u5225\\u306E\\u5834\\u6240\\u306B\\u79FB\\u52D5\\u3067\\u304D\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u30C9\\u30E9\\u30C3\\u30B0\\u4E2D\\u306F\\u914D\\u7F6E\\u4E88\\u5B9A\\u4F4D\\u7F6E\\u306B\\u9752\\u3044\\u5F71\\u304C\\u8868\\u793A\\u3055\\u308C\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u97F3\\u7D20\\u6750\\u306F8\\u5206\\u97F3\\u7B26\\uFF08\\u88CF\\u62CD\\u542B\\u3080\\uFF09\\u306B\\u5408\\u308F\\u305B\\u3066\\u81EA\\u52D5\\u7684\\u306B\\u914D\\u7F6E\\u3055\\u308C\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u97F3\\u7D20\\u6750\\u30D1\\u30CD\\u30EB\\u306E\\u25B6\\uFE0F\\u30DC\\u30BF\\u30F3\\u3067\\u500B\\u5225\\u306B\\u97F3\\u3092\\u78BA\\u8A8D\\u3067\\u304D\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u25B6\\uFE0F\\u30DC\\u30BF\\u30F3\\u3067\\u518D\\u751F\\u3001\\u23F8\\uFE0F\\u30DC\\u30BF\\u30F3\\u3067\\u4E00\\u6642\\u505C\\u6B62\\u3001\\u23F9\\uFE0F\\u30DC\\u30BF\\u30F3\\u3067\\u505C\\u6B62\"}),/*#__PURE__*/_jsx(\"li\",{children:\"BPM\\u3092\\u5909\\u66F4\\u3057\\u3066\\u97F3\\u697D\\u306E\\u901F\\u3055\\u3092\\u8ABF\\u6574\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u30C8\\u30E9\\u30C3\\u30AF\\u3092\\u8FFD\\u52A0\\u3057\\u3066\\u8907\\u6570\\u306E\\u97F3\\u3092\\u91CD\\u306D\\u308B\\u3053\\u3068\\u304C\\u3067\\u304D\\u307E\\u3059\"}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDCBE \\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u4FDD\\u5B58:\"}),\" \\u7DE8\\u96C6\\u4E2D\\u306E\\u30C7\\u30FC\\u30BF\\u3092JSON\\u30D5\\u30A1\\u30A4\\u30EB\\u3068\\u3057\\u3066\\u4FDD\\u5B58\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDCC1 \\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u8AAD\\u307F\\u8FBC\\u307F:\"}),\" \\u4FDD\\u5B58\\u3057\\u305F\\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u30D5\\u30A1\\u30A4\\u30EB\\u3092\\u8AAD\\u307F\\u8FBC\\u3093\\u3067\\u7DE8\\u96C6\\u3092\\u518D\\u958B\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83C\\uDFA7 \\u97F3\\u6E90\\u51FA\\u529B:\"}),\" \\u5B8C\\u6210\\u3057\\u305F\\u697D\\u66F2\\u3092WAV\\u30D5\\u30A1\\u30A4\\u30EB\\u3068\\u3057\\u3066\\u51FA\\u529B\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\uD83D\\uDDD1\\uFE0F \\u30EA\\u30BB\\u30C3\\u30C8:\"}),\" \\u73FE\\u5728\\u306E\\u30D7\\u30ED\\u30B8\\u30A7\\u30AF\\u30C8\\u3092\\u30EA\\u30BB\\u30C3\\u30C8\\u3057\\u3066\\u65B0\\u3057\\u304F\\u59CB\\u3081\\u308B\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"auto-save-info\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"\\uD83D\\uDCBE \\u81EA\\u52D5\\u4FDD\\u5B58\\u6A5F\\u80FD\"}),/*#__PURE__*/_jsxs(\"ul\",{children:[/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u81EA\\u52D5\\u4FDD\\u5B58:\"}),\" \\u30C8\\u30E9\\u30C3\\u30AF\\u3084BPM\\u306E\\u5909\\u66F4\\u306F\\u81EA\\u52D5\\u7684\\u306B\\u4FDD\\u5B58\\u3055\\u308C\\u307E\\u3059\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u4ED6\\u30DA\\u30FC\\u30B8\\u3068\\u306E\\u9023\\u643A:\"}),\" \\u300C\\u97F3\\u3042\\u3064\\u3081\\u300D\\u30DA\\u30FC\\u30B8\\u3067\\u9332\\u97F3\\u3057\\u305F\\u97F3\\u306F\\u81EA\\u52D5\\u7684\\u306B\\u53CD\\u6620\\u3055\\u308C\\u307E\\u3059\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u5FA9\\u5143\\u6A5F\\u80FD:\"}),\" \\u30DA\\u30FC\\u30B8\\u3092\\u30EA\\u30ED\\u30FC\\u30C9\\u3057\\u3066\\u3082\\u4F5C\\u696D\\u5185\\u5BB9\\u304C\\u81EA\\u52D5\\u7684\\u306B\\u5FA9\\u5143\\u3055\\u308C\\u307E\\u3059\"]}),/*#__PURE__*/_jsxs(\"li\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"\\u5B89\\u5FC3\\u3057\\u3066\\u79FB\\u52D5:\"}),\" \\u4ED6\\u306E\\u30DA\\u30FC\\u30B8\\u306B\\u79FB\\u52D5\\u3057\\u3066\\u3082\\u4F5C\\u696D\\u5185\\u5BB9\\u306F\\u4FDD\\u6301\\u3055\\u308C\\u307E\\u3059\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"mobile-tips\",children:[/*#__PURE__*/_jsx(\"h4\",{children:\"\\uD83D\\uDCF1 \\u30B9\\u30DE\\u30FC\\u30C8\\u30D5\\u30A9\\u30F3\\u5229\\u7528\\u306E\\u30B3\\u30C4\"}),/*#__PURE__*/_jsxs(\"ul\",{children:[/*#__PURE__*/_jsx(\"li\",{children:\"\\u97F3\\u7D20\\u6750\\u3092\\u8EFD\\u304F\\u9577\\u62BC\\u3057\\u3059\\u308B\\u3068\\u30C9\\u30E9\\u30C3\\u30B0\\u30E2\\u30FC\\u30C9\\u306B\\u306A\\u308A\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u30C9\\u30E9\\u30C3\\u30B0\\u4E2D\\u306F\\u753B\\u9762\\u304C\\u30B9\\u30AF\\u30ED\\u30FC\\u30EB\\u3057\\u306A\\u3044\\u3088\\u3046\\u5236\\u5FA1\\u3055\\u308C\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u9752\\u304F\\u30CF\\u30A4\\u30E9\\u30A4\\u30C8\\u3055\\u308C\\u305F\\u30C8\\u30E9\\u30C3\\u30AF\\u3067\\u6307\\u3092\\u96E2\\u3059\\u3068\\u97F3\\u7D20\\u6750\\u304C\\u914D\\u7F6E\\u3055\\u308C\\u307E\\u3059\"}),/*#__PURE__*/_jsx(\"li\",{children:\"\\u6A2A\\u753B\\u9762\\u8868\\u793A\\u306B\\u3059\\u308B\\u3068\\u3088\\u308A\\u4F7F\\u3044\\u3084\\u3059\\u304F\\u306A\\u308A\\u307E\\u3059\"})]})]})]})]});};const SoundItem=_ref5=>{let{sound,onDragStart}=_ref5;const[isPlaying,setIsPlaying]=useState(false);const[isDragging,setIsDragging]=useState(false);const[touchStart,setTouchStart]=useState(null);const[touchMove,setTouchMove]=useState(null);const handleDragStart=e=>{// audioBlobä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦è¨­å®š\nconst soundDataForTransfer=_objectSpread(_objectSpread({},sound),{},{audioBlob:null// Blobã¯ç›´æ¥ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ãŸã‚ä¸€æ™‚çš„ã«nullã«\n});e.dataTransfer.setData('application/json',JSON.stringify(soundDataForTransfer));e.dataTransfer.effectAllowed='copy';// å®Ÿéš›ã®audioBlobã¯åˆ¥é€”ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ\nwindow.currentDraggedSoundBlob=sound.audioBlob;// è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®onDragStarté–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆéŸ³å£°ã®é•·ã•ã‚’è¨ˆç®—ï¼‰\nif(onDragStart){onDragStart(sound);}};// ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ\nconst handleTouchStart=e=>{const touch=e.touches[0];setTouchStart({x:touch.clientX,y:touch.clientY});setIsDragging(false);// é•·æŠ¼ã—åˆ¤å®šç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã¯è¨­å®šã›ãšã€ç§»å‹•æ¤œçŸ¥ã§ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°ã‚’é–‹å§‹\n};const handleTouchMove=e=>{if(!touchStart)return;const touch=e.touches[0];const currentPos={x:touch.clientX,y:touch.clientY};setTouchMove(currentPos);// ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®åˆ¤å®šï¼ˆ15pxä»¥ä¸Šç§»å‹•ï¼‰- é–¾å€¤ã‚’ä¸Šã’ã¦ã‚ˆã‚Šæ„å›³çš„ãªç§»å‹•ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°æ‰±ã„\nconst deltaX=Math.abs(currentPos.x-touchStart.x);const deltaY=Math.abs(currentPos.y-touchStart.y);if(!isDragging&&(deltaX>15||deltaY>15)){setIsDragging(true);// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰ï¼‰\ndocument.body.classList.add('dragging');// è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®onDragStarté–¢æ•°ã‚’å‘¼ã³å‡ºã—\nif(onDragStart){onDragStart(sound);}// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š\nwindow.currentDraggedSoundBlob=sound.audioBlob;window.currentDraggedSound=sound;}if(isDragging){// passiveã‚¤ãƒ™ãƒ³ãƒˆã§ã¯preventDefaultãŒä½¿ãˆãªã„ã®ã§ã€ä»£ã‚ã‚Šã«touchActionã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åˆ¶å¾¡\n// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°\nconst dragPreview=document.querySelector('.mobile-drag-preview');if(dragPreview){dragPreview.style.left=\"\".concat(currentPos.x-50,\"px\");dragPreview.style.top=\"\".concat(currentPos.y-20,\"px\");}// ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ\nconst elementBelow=document.elementFromPoint(currentPos.x,currentPos.y);const trackElement=elementBelow===null||elementBelow===void 0?void 0:elementBelow.closest('.track');// æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\ndocument.querySelectorAll('.track').forEach(track=>{track.classList.remove('drag-over');});// æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ \nif(trackElement){trackElement.classList.add('drag-over');}}};const handleTouchEnd=e=>{if(isDragging&&touchMove){// ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\nconst elementBelow=document.elementFromPoint(touchMove.x,touchMove.y);const trackElement=elementBelow===null||elementBelow===void 0?void 0:elementBelow.closest('.track');if(trackElement){const trackId=parseInt(trackElement.dataset.trackId);const rect=trackElement.getBoundingClientRect();const timePosition=touchMove.x-rect.left;// ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«\nconst dropEvent=new CustomEvent('mobileDrop',{detail:{trackId,timePosition,sound:sound}});trackElement.dispatchEvent(dropEvent);}}// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nsetTouchStart(null);setTouchMove(null);setIsDragging(false);// SoundItem å†…ã§ã®ç›´æ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\ndocument.body.classList.remove('dragging');// ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\ndocument.querySelectorAll('.track').forEach(track=>{track.classList.remove('drag-over');});// ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤\nconst mobileDragPreview=document.querySelector('.mobile-drag-preview');if(mobileDragPreview){mobileDragPreview.remove();}// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢\nif(window.currentDraggedSoundBlob){window.currentDraggedSoundBlob=null;}if(window.currentDraggedSound){window.currentDraggedSound=null;}};const playSound=()=>{if(sound.audioBlob&&!isPlaying&&!isDragging){// Blobã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯\nif(!(sound.audioBlob instanceof Blob)||sound.audioBlob.size===0){var _sound$audioBlob;console.error('ç„¡åŠ¹ãªaudioBlob:',{name:sound.name,isBlob:sound.audioBlob instanceof Blob,size:(_sound$audioBlob=sound.audioBlob)===null||_sound$audioBlob===void 0?void 0:_sound$audioBlob.size});return;}const audio=new Audio();let audioUrl;try{audioUrl=URL.createObjectURL(sound.audioBlob);audio.src=audioUrl;audio.play().then(()=>{setIsPlaying(true);const handleEnded=()=>{setIsPlaying(false);if(audioUrl){URL.revokeObjectURL(audioUrl);// URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n}audio.removeEventListener('ended',handleEnded);};audio.addEventListener('ended',handleEnded);// éŸ³å£°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚‚ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\naudio.addEventListener('error',error=>{console.error('éŸ³å£°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:',error);setIsPlaying(false);if(audioUrl){URL.revokeObjectURL(audioUrl);}});}).catch(error=>{console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:',error);if(audioUrl){URL.revokeObjectURL(audioUrl);// ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n}setIsPlaying(false);});}catch(error){console.error('createObjectURLã‚¨ãƒ©ãƒ¼:',error);setIsPlaying(false);}}else{console.log('å†ç”Ÿæ¡ä»¶ä¸æº€è¶³:',{hasAudioBlob:!!sound.audioBlob,isPlaying,isDragging});}};// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ\nconst createDragPreview=useCallback(()=>{if(isDragging&&touchMove){let dragPreview=document.querySelector('.mobile-drag-preview');if(!dragPreview){dragPreview=document.createElement('div');dragPreview.className='mobile-drag-preview';dragPreview.textContent=sound.name;dragPreview.style.cssText=\"\\n          position: fixed;\\n          background: rgba(0, 123, 255, 0.8);\\n          color: white;\\n          padding: 5px 10px;\\n          border-radius: 4px;\\n          font-size: 12px;\\n          pointer-events: none;\\n          z-index: 1000;\\n          left: \".concat(touchMove.x-50,\"px;\\n          top: \").concat(touchMove.y-20,\"px;\\n        \");document.body.appendChild(dragPreview);}}},[isDragging,touchMove,sound.name]);// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°\nReact.useEffect(()=>{if(isDragging){createDragPreview();}},[isDragging,touchMove,createDragPreview]);return/*#__PURE__*/_jsxs(\"div\",{className:\"sound-item \".concat(isDragging?'dragging':''),draggable:\"true\",onDragStart:handleDragStart,onTouchStart:handleTouchStart,onTouchMove:handleTouchMove,onTouchEnd:handleTouchEnd,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"sound-info\",children:[/*#__PURE__*/_jsx(\"h4\",{children:sound.name}),/*#__PURE__*/_jsx(\"div\",{className:\"sound-tags\",children:sound.tags.map((tag,index)=>/*#__PURE__*/_jsx(\"span\",{className:\"sound-tag\",children:tag},index))})]}),/*#__PURE__*/_jsx(\"div\",{className:\"sound-actions\",children:/*#__PURE__*/_jsx(\"button\",{className:\"play-sound-btn\",onClick:playSound,disabled:isPlaying,children:isPlaying?'â¸ï¸':'â–¶ï¸'})})]});};const TrackHeader=_ref6=>{let{track,onRemove,trackHeight}=_ref6;return/*#__PURE__*/_jsx(\"div\",{className:\"track-header\",style:{height:trackHeight},children:/*#__PURE__*/_jsxs(\"div\",{className:\"track-info\",children:[/*#__PURE__*/_jsx(\"h4\",{children:track.name}),/*#__PURE__*/_jsx(\"div\",{className:\"track-actions\",children:/*#__PURE__*/_jsx(\"button\",{className:\"remove-track-btn\",onClick:()=>onRemove(track.id),title:\"\\u30C8\\u30E9\\u30C3\\u30AF\\u3092\\u524A\\u9664\",children:\"\\uD83D\\uDDD1\\uFE0F\"})})]})});};const Timeline=_ref7=>{let{bpm}=_ref7;const measures=TOTAL_MEASURES;// 16å°ç¯€è¡¨ç¤º\nconst beatsPerMeasure=BEATS_PER_MEASURE;// 4/4æ‹å­\nreturn/*#__PURE__*/_jsx(\"div\",{className:\"timeline\",style:{minWidth:TOTAL_MEASURES*MEASURE_WIDTH},children:Array.from({length:measures},(_,measureIndex)=>/*#__PURE__*/_jsxs(\"div\",{className:\"measure\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"measure-number\",children:measureIndex+1}),/*#__PURE__*/_jsx(\"div\",{className:\"beats\",children:Array.from({length:beatsPerMeasure},(_,beatIndex)=>/*#__PURE__*/_jsxs(\"div\",{className:\"beat\",style:{width:BEAT_WIDTH},children:[/*#__PURE__*/_jsx(\"div\",{className:\"beat-main\",children:beatIndex+1}),/*#__PURE__*/_jsx(\"div\",{className:\"beat-sub\",children:/*#__PURE__*/_jsx(\"div\",{className:\"sub-beat-marker\",children:\"\\u30FB\"})})]},beatIndex))})]},measureIndex))});};const Track=_ref8=>{let{track,onDrop,onDragOver,onRemoveClip,onClipDragStart,onDragEnd,trackHeight,bpm,updateDragPreview}=_ref8;const handleDrop=e=>{const rect=e.currentTarget.getBoundingClientRect();const timePosition=e.clientX-rect.left;onDrop(e,track.id,timePosition);};// ãƒ¢ãƒã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†\nconst handleMobileDrop=useCallback(e=>{const{trackId,timePosition,sound}=e.detail;// æ¨¡æ“¬çš„ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ\nconst mockDropEvent={preventDefault:()=>{},dataTransfer:{getData:type=>{if(type==='application/json'){return JSON.stringify(sound);}return'';}}};onDrop(mockDropEvent,trackId,timePosition);},[onDrop]);// ãƒ¢ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒãƒ—ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†\nconst handleMobileClipMove=useCallback(e=>{const{clip,newTrackId,timePosition}=e.detail;// æ¨¡æ“¬çš„ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ\nconst mockDropEvent={preventDefault:()=>{},dataTransfer:{getData:type=>{if(type==='text/plain'){return\"existing-clip-\".concat(clip.id);}return'';}}};onDrop(mockDropEvent,newTrackId,timePosition);},[onDrop]);const handleUpdateDragPreview=useCallback(e=>{const{clientX,trackElement}=e.detail;// è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®updateDragPreviewé–¢æ•°ã‚’å‘¼ã³å‡ºã—\nif(typeof updateDragPreview==='function'){updateDragPreview(clientX,trackElement);}},[]);React.useEffect(()=>{const trackElement=document.querySelector(\"[data-track-id=\\\"\".concat(track.id,\"\\\"]\"));if(trackElement){trackElement.addEventListener('mobileDrop',handleMobileDrop);trackElement.addEventListener('mobileClipMove',handleMobileClipMove);trackElement.addEventListener('updateDragPreview',handleUpdateDragPreview);return()=>{trackElement.removeEventListener('mobileDrop',handleMobileDrop);trackElement.removeEventListener('mobileClipMove',handleMobileClipMove);trackElement.removeEventListener('updateDragPreview',handleUpdateDragPreview);};}},[track.id,handleMobileDrop,handleMobileClipMove,handleUpdateDragPreview]);return/*#__PURE__*/_jsxs(\"div\",{className:\"track\",style:{height:trackHeight},\"data-track-id\":track.id,onDrop:handleDrop,onDragOver:onDragOver,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"track-grid\",children:[Array.from({length:TOTAL_BEATS},(_,index)=>{const isFirstBeat=index===0;const isMeasureStart=index%BEATS_PER_MEASURE===0;const className=\"beat-line beat-line-main \".concat(isFirstBeat?'first-beat':'',\" \").concat(isMeasureStart?'measure-start':'');return/*#__PURE__*/_jsx(\"div\",{className:className,style:{left:index*BEAT_WIDTH}},\"main-\".concat(index));}),Array.from({length:TOTAL_BEATS},(_,index)=>/*#__PURE__*/_jsx(\"div\",{className:\"beat-line beat-line-sub\",style:{left:index*BEAT_WIDTH+SUB_BEAT_WIDTH}},\"sub-\".concat(index)))]}),track.clips.map(clip=>/*#__PURE__*/_jsx(AudioClip,{clip:clip,trackId:track.id,onRemove:()=>onRemoveClip(track.id,clip.id),onDragStart:onClipDragStart,onDragEnd:onDragEnd},clip.id))]});};const AudioClip=_ref9=>{var _clip$soundData7;let{clip,trackId,onRemove,onDragStart,onDragEnd}=_ref9;const[waveformData,setWaveformData]=React.useState([]);const[isDragging,setIsDragging]=React.useState(false);const[touchStart,setTouchStart]=React.useState(null);const[touchMove,setTouchMove]=React.useState(null);React.useEffect(()=>{// clip.soundData ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ\nif(clip&&clip.soundData){// ç°¡å˜ãªæ³¢å½¢ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯éŸ³å£°è§£æãŒå¿…è¦ï¼‰\nconst generateWaveform=()=>{const points=20;// æ³¢å½¢ã®ãƒã‚¤ãƒ³ãƒˆæ•°\nconst data=[];for(let i=0;i<points;i++){data.push(Math.random()*0.8+0.2);// 0.2-1.0ã®é–“ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤\n}setWaveformData(data);};generateWaveform();}},[clip,clip===null||clip===void 0?void 0:clip.soundData]);// clip.soundData ã®å®‰å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆHooksã®å¾Œã§ï¼‰\nif(!clip||!clip.soundData){console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿:',clip);return null;// ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã¯è¡¨ç¤ºã—ãªã„\n}const handleDragStart=e=>{e.stopPropagation();// ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ–ãƒªãƒ³ã‚°ã‚’é˜²ã\n// ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã«æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®æƒ…å ±ã‚’è¨­å®š\ne.dataTransfer.setData('text/plain',\"existing-clip-\".concat(clip.id));e.dataTransfer.effectAllowed='move';// onDragStartã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ï¼ˆãƒã‚¦ã‚¹ä½ç½®ã¨ã‚¯ãƒªãƒƒãƒ—è¦ç´ ã‚’æ¸¡ã™ï¼‰\nonDragStart(clip,trackId,e.clientX,e.currentTarget);};const handleDragEnd=e=>{// ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‘¼ã³å‡ºã—\nif(onDragEnd){onDragEnd(e);}};// ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼ˆã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ï¼‰\nconst handleTouchStart=e=>{e.stopPropagation();const touch=e.touches[0];setTouchStart({x:touch.clientX,y:touch.clientY});setIsDragging(false);// ãƒ‰ãƒ©ãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰æœ‰åŠ¹åŒ–\n};const handleTouchMove=e=>{if(!touchStart)return;const touch=e.touches[0];const currentPos={x:touch.clientX,y:touch.clientY};setTouchMove(currentPos);// ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®åˆ¤å®šï¼ˆ10pxä»¥ä¸Šç§»å‹•ï¼‰\nconst deltaX=Math.abs(currentPos.x-touchStart.x);const deltaY=Math.abs(currentPos.y-touchStart.y);if(!isDragging&&(deltaX>10||deltaY>10)){setIsDragging(true);// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰ï¼‰\ndocument.body.classList.add('dragging');onDragStart(clip,trackId,touchStart.x,e.currentTarget);}if(isDragging){// passiveã‚¤ãƒ™ãƒ³ãƒˆã§ã¯preventDefaultãŒä½¿ãˆãªã„ã®ã§ã€touchActionã§åˆ¶å¾¡\n// ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ\nconst elementBelow=document.elementFromPoint(currentPos.x,currentPos.y);const trackElement=elementBelow===null||elementBelow===void 0?void 0:elementBelow.closest('.track');// æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\ndocument.querySelectorAll('.track').forEach(track=>{track.classList.remove('drag-over');});// æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ ï¼ˆè‡ªåˆ†ã®ãƒˆãƒ©ãƒƒã‚¯ä»¥å¤–ã‚‚å«ã‚€ï¼‰\nif(trackElement){trackElement.classList.add('drag-over');// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚æ›´æ–°ï¼ˆonDragStartæ™‚ã¨åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰\nif(onDragStart){// è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®updateDragPreviewé–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ\nconst dragPreviewEvent=new CustomEvent('updateDragPreview',{detail:{clientX:currentPos.x,trackElement:trackElement}});trackElement.dispatchEvent(dragPreviewEvent);}}}};const handleTouchEnd=e=>{if(isDragging&&touchMove){// ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\nconst elementBelow=document.elementFromPoint(touchMove.x,touchMove.y);const trackElement=elementBelow===null||elementBelow===void 0?void 0:elementBelow.closest('.track');if(trackElement){const newTrackId=parseInt(trackElement.dataset.trackId);const rect=trackElement.getBoundingClientRect();const timePosition=touchMove.x-rect.left;// æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«\nconst moveEvent=new CustomEvent('mobileClipMove',{detail:{clip,originalTrackId:trackId,newTrackId,timePosition}});trackElement.dispatchEvent(moveEvent);}}// ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\nsetTouchStart(null);setTouchMove(null);setIsDragging(false);document.body.classList.remove('dragging');// ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\ndocument.querySelectorAll('.track').forEach(track=>{track.classList.remove('drag-over');});// ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆè¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆï¼‰\nif(onDragEnd){onDragEnd(null);// nullã‚’æ¸¡ã—ã¦ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã‚’æº€ãŸã™\n}};return/*#__PURE__*/_jsxs(\"div\",{className:\"audio-clip \".concat(isDragging?'dragging':''),draggable:\"true\",onDragStart:handleDragStart,onDragEnd:handleDragEnd,onTouchStart:handleTouchStart,onTouchMove:handleTouchMove,onTouchEnd:handleTouchEnd,style:{left:clip.startTime,width:isFinite(clip.duration)&&clip.duration>0?clip.duration:400// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å°ç¯€\n},children:[/*#__PURE__*/_jsxs(\"div\",{className:\"clip-header\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"clip-name\",children:((_clip$soundData7=clip.soundData)===null||_clip$soundData7===void 0?void 0:_clip$soundData7.name)||'ä¸æ˜ãªéŸ³ç´ æ'}),/*#__PURE__*/_jsx(\"button\",{className:\"remove-clip-btn\",onClick:onRemove,title:\"\\u30AF\\u30EA\\u30C3\\u30D7\\u3092\\u524A\\u9664\",children:\"\\xD7\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"clip-waveform\",children:waveformData.length>0?/*#__PURE__*/_jsx(\"svg\",{className:\"waveform-svg\",width:\"100%\",height:\"30\",children:waveformData.map((height,index)=>/*#__PURE__*/_jsx(\"rect\",{x:\"\".concat(index/waveformData.length*100,\"%\"),y:\"\".concat((1-height)*15),width:\"\".concat(80/waveformData.length,\"%\"),height:\"\".concat(height*30),fill:\"rgba(255, 255, 255, 0.8)\"},index))}):/*#__PURE__*/_jsx(\"div\",{className:\"waveform-placeholder\",children:\"\\uD83D\\uDD0A\"})})]});};const Playhead=_ref0=>{let{currentTime}=_ref0;// currentTimeãŒæœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\nconst safeCurrentTime=isFinite(currentTime)&&currentTime>=0?currentTime:0;return/*#__PURE__*/_jsx(\"div\",{className:\"playhead\",style:{left:safeCurrentTime}});};export default DAWPage;","map":{"version":3,"names":["React","useState","useRef","useEffect","useCallback","jsx","_jsx","jsxs","_jsxs","BEAT_WIDTH","BEATS_PER_MEASURE","MEASURE_WIDTH","SUB_BEAT_WIDTH","TOTAL_MEASURES","TOTAL_BEATS","DAWPage","trackIdCounterRef","trackNameCounterRef","loadAutoSavedProject","autoSavedData","localStorage","getItem","projectData","JSON","parse","console","log","trackNameCounter","current","trackIdCounter","validTracks","tracks","map","track","_objectSpread","clips","filter","clip","soundData","name","warn","length","id","Date","now","bpm","error","initialData","setTracks","setBpm","isPlaying","setIsPlaying","currentTime","setCurrentTime","audioContext","setAudioContext","trackHeight","playingAudios","setPlayingAudios","Map","startPlayTime","setStartPlayTime","setError","sounds","setSounds","showSoundPanel","setShowSoundPanel","draggedClip","setDraggedClip","dragPreview","setDragPreview","draggedSoundDuration","setDraggedSoundDuration","dragOffset","setDragOffset","isExporting","setIsExporting","timelineRef","animationFrameRef","dragOverTimeoutRef","ctx","window","AudioContext","webkitAudioContext","savedSounds","soundsWithBlob","sound","audioData","includes","base64Data","split","byteCharacters","atob","byteNumbers","Array","i","charCodeAt","byteArray","Uint8Array","blob","Blob","type","size","audioBlob","validSounds","validSoundsForStorage","undefined","setItem","stringify","state","close","catch","cancelAnimationFrame","clearTimeout","currentPlayingAudios","forEach","_ref","audio","timeoutId","audioUrl","pause","src","URL","revokeObjectURL","currentDraggedSoundBlob","currentDraggedSound","getAudioDuration","currentBpm","arguments","Promise","resolve","arrayBuffer","audioBuffer","decodeAudioData","durationInSeconds","duration","isFinite","pixelsPerSecond","widthInPixels","updatePlayhead","animate","elapsed","newCurrentTime","requestAnimationFrame","timeInSeconds","handleBpmChange","newBpm","updatedTracks","all","updatedClips","newDuration","saveProject","version","timestamp","projectJson","url","createObjectURL","link","document","createElement","href","download","concat","toISOString","slice","replace","body","appendChild","click","removeChild","loadProject","event","file","target","files","reader","FileReader","onload","e","result","Error","restoreAudioBlob","restoredTracks","restoredSounds","prevSounds","maxId","Math","max","s","existingNames","Set","newSounds","index","newName","counter","has","add","setTimeout","autoSaveData","readAsText","value","exportAudio","maxDuration","clipStartTimeInSeconds","startTime","clipDurationInSeconds","clipEndTime","exportContext","sampleRate","bufferLength","ceil","outputBuffer","createBuffer","leftChannel","getChannelData","rightChannel","startTimeInSamples","floor","channel","min","numberOfChannels","sourceData","targetData","wavBlob","audioBufferToWav","buffer","bytesPerSample","blockAlign","byteRate","dataSize","bufferSize","ArrayBuffer","view","DataView","writeString","offset","string","setUint8","setUint32","setUint16","sample","intSample","setInt16","addTrack","uniqueId","trackName","newTrack","prevTracks","removeTrack","trackId","handleDrop","timePosition","preventDefault","originalTrackId","adjustedPosition","snappedPosition","round","updatedClip","jsonData","dataTransfer","getData","hasAudioBlob","newClip","random","find","t","handleDragOver","dropEffect","clientX","currentTarget","updateDragPreview","trackElement","dragCleanupTimer","cleanupDragState","rect","getBoundingClientRect","left","trackRect","tracksAreaRect","dataset","relativeTop","top","parseInt","isNaN","previewWidth","width","removeClip","clipId","handleClipDragStart","mouseX","clipElement","clipRect","offsetInClip","querySelectorAll","classList","remove","mobileDragPreview","querySelector","cleanupDragStateCallback","handleGlobalDragEnd","handleGlobalDragLeave","relatedTarget","nodeName","addEventListener","removeEventListener","handleDragEnd","play","resume","currentTimeInSeconds","newPlayingAudios","clipEndTimeInSeconds","delay","scheduleClipPlayback","delayMs","playingAudiosMap","_clip$soundData","Audio","set","_clip$soundData2","_clip$soundData3","_clip$soundData4","_clip$soundData5","_clip$soundData6","soundDataName","hasAudioData","audioBlobType","isInstanceOfBlob","restoreError","_ref2","paused","stop","_ref3","autoSaveProject","tracksCount","totalClips","reduce","total","handleVisibilityChange","hidden","clearAutoSave","removeItem","alert","cleanupInvalidClips","cleanedTracks","removedCount","timer","_ref4","className","children","onClick","htmlFor","onChange","accept","style","display","confirm","title","disabled","SoundItem","onDragStart","TrackHeader","onRemove","Timeline","ref","minWidth","Playhead","Track","onDrop","onDragOver","onRemoveClip","onClipDragStart","onDragEnd","_ref5","isDragging","setIsDragging","touchStart","setTouchStart","touchMove","setTouchMove","handleDragStart","soundDataForTransfer","setData","effectAllowed","handleTouchStart","touch","touches","x","y","clientY","handleTouchMove","currentPos","deltaX","abs","deltaY","elementBelow","elementFromPoint","closest","handleTouchEnd","dropEvent","CustomEvent","detail","dispatchEvent","playSound","_sound$audioBlob","isBlob","then","handleEnded","createDragPreview","textContent","cssText","draggable","onTouchStart","onTouchMove","onTouchEnd","tags","tag","_ref6","height","_ref7","measures","beatsPerMeasure","from","_","measureIndex","beatIndex","_ref8","handleMobileDrop","mockDropEvent","handleMobileClipMove","newTrackId","handleUpdateDragPreview","isFirstBeat","isMeasureStart","AudioClip","_ref9","_clip$soundData7","waveformData","setWaveformData","generateWaveform","points","data","push","stopPropagation","dragPreviewEvent","moveEvent","fill","_ref0","safeCurrentTime"],"sources":["/Users/nakataniyuutomo/Desktop/Programing/ã‚»ã‚™ãƒŸé–‹ç™º/sound-library2/src/pages/DAWPage.js"],"sourcesContent":["import React, { useState, useRef, useEffect, useCallback } from 'react';\nimport './DAWPage.css';\n\n// DAWã®å®šæ•°\nconst BEAT_WIDTH = 100; // 1æ‹ã®å¹…ï¼ˆpxï¼‰\nconst BEATS_PER_MEASURE = 4; // 1å°ç¯€ã‚ãŸã‚Šã®æ‹æ•°\nconst MEASURE_WIDTH = BEAT_WIDTH * BEATS_PER_MEASURE; // 1å°ç¯€ã®å¹…ï¼ˆ400pxï¼‰\nconst SUB_BEAT_WIDTH = BEAT_WIDTH / 2; // 8åˆ†éŸ³ç¬¦ã®å¹…ï¼ˆ50pxï¼‰\nconst TOTAL_MEASURES = 16; // è¡¨ç¤ºã™ã‚‹å°ç¯€æ•°\nconst TOTAL_BEATS = TOTAL_MEASURES * BEATS_PER_MEASURE; // ç·æ‹æ•°\n\nconst DAWPage = () => {\n  // ãƒ¦ãƒ‹ãƒ¼ã‚¯IDç”Ÿæˆç”¨ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼\n  const trackIdCounterRef = useRef(1);\n  // ãƒˆãƒ©ãƒƒã‚¯åã®ç•ªå·ç®¡ç†ç”¨ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼\n  const trackNameCounterRef = useRef(1);\n  \n  // LocalStorageã‹ã‚‰ã®è‡ªå‹•å¾©å…ƒæ©Ÿèƒ½\n  const loadAutoSavedProject = () => {\n    try {\n      const autoSavedData = localStorage.getItem('dawProjectAutoSave');\n      if (autoSavedData) {\n        const projectData = JSON.parse(autoSavedData);\n        console.log('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒä¸­...', projectData);\n        \n        // ãƒˆãƒ©ãƒƒã‚¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®å¾©å…ƒ\n        if (projectData.trackNameCounter) {\n          trackNameCounterRef.current = projectData.trackNameCounter;\n        }\n        if (projectData.trackIdCounter) {\n          trackIdCounterRef.current = projectData.trackIdCounter;\n        }\n        \n        // ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°\n        const validTracks = (projectData.tracks || []).map(track => ({\n          ...track,\n          clips: (track.clips || []).filter(clip => {\n            if (!clip.soundData || !clip.soundData.name) {\n              console.warn('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:', clip);\n              return false;\n            }\n            return true;\n          })\n        }));\n        \n        return {\n          tracks: validTracks.length > 0 ? validTracks : [{ \n            id: Date.now(), \n            name: 'ãƒˆãƒ©ãƒƒã‚¯ 1', \n            clips: [] \n          }],\n          bpm: projectData.bpm || 120\n        };\n      }\n    } catch (error) {\n      console.error('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:', error);\n    }\n    \n    return {\n      tracks: [{ \n        id: Date.now(), \n        name: 'ãƒˆãƒ©ãƒƒã‚¯ 1', \n        clips: [] \n      }],\n      bpm: 120\n    };\n  };\n\n  const initialData = loadAutoSavedProject();\n  const [tracks, setTracks] = useState(initialData.tracks);\n  const [bpm, setBpm] = useState(initialData.bpm);\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [currentTime, setCurrentTime] = useState(0);\n  const [audioContext, setAudioContext] = useState(null);\n  const [trackHeight] = useState(80);\n  const [playingAudios, setPlayingAudios] = useState(new Map());\n  const [startPlayTime, setStartPlayTime] = useState(null);\n  const [error, setError] = useState(null);\n  const [sounds, setSounds] = useState([]);\n  const [showSoundPanel, setShowSoundPanel] = useState(true);\n  const [draggedClip, setDraggedClip] = useState(null);\n  const [dragPreview, setDragPreview] = useState(null);\n  const [draggedSoundDuration, setDraggedSoundDuration] = useState(400); // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®éŸ³ç´ æã®é•·ã•\n  const [dragOffset, setDragOffset] = useState(0); // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã®ã‚¯ãƒªãƒƒãƒ—å†…ã‚ªãƒ•ã‚»ãƒƒãƒˆ\n  const [isExporting, setIsExporting] = useState(false); // éŸ³æºå‡ºåŠ›ä¸­ãƒ•ãƒ©ã‚°\n  const timelineRef = useRef(null);\n  const animationFrameRef = useRef(null);\n  const dragOverTimeoutRef = useRef(null);\n\n  useEffect(() => {\n    // Web Audio API ã®åˆæœŸåŒ–\n    const ctx = new (window.AudioContext || window.webkitAudioContext)();\n    setAudioContext(ctx);\n    \n    // LocalStorageã‹ã‚‰éŸ³ç´ æã‚’èª­ã¿è¾¼ã¿\n    const savedSounds = JSON.parse(localStorage.getItem('soundRecordings') || '[]');\n    console.log('LocalStorageã‹ã‚‰èª­ã¿è¾¼ã‚“ã éŸ³ç´ ææ•°:', savedSounds.length);\n    \n    // audioDataã‹ã‚‰Blobã‚’å¾©å…ƒ\n    const soundsWithBlob = savedSounds.map(sound => {\n      if (sound.audioData) {\n        try {\n          console.log('éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒä¸­:', sound.name, 'ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', sound.audioData.length);\n          \n          // Base64ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼\n          if (!sound.audioData.includes(',')) {\n            console.error('ç„¡åŠ¹ãªBase64ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:', sound.name);\n            return sound;\n          }\n          \n          const base64Data = sound.audioData.split(',')[1];\n          if (!base64Data || base64Data.length === 0) {\n            console.error('Base64ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™:', sound.name);\n            return sound;\n          }\n          \n          const byteCharacters = atob(base64Data);\n          const byteNumbers = new Array(byteCharacters.length);\n          for (let i = 0; i < byteCharacters.length; i++) {\n            byteNumbers[i] = byteCharacters.charCodeAt(i);\n          }\n          const byteArray = new Uint8Array(byteNumbers);\n          \n          // Blobã‚µã‚¤ã‚ºã®æ¤œè¨¼\n          if (byteArray.length === 0) {\n            console.error('Blobãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™:', sound.name);\n            return sound;\n          }\n          \n          const blob = new Blob([byteArray], { type: 'audio/wav' });\n          console.log('Blobå¾©å…ƒæˆåŠŸ:', sound.name, 'ã‚µã‚¤ã‚º:', blob.size, 'ã‚¿ã‚¤ãƒ—:', blob.type);\n          \n          // Blobã®æœ‰åŠ¹æ€§ã‚’ç¢ºèª\n          if (blob.size === 0) {\n            console.error('ä½œæˆã•ã‚ŒãŸBlobã®ã‚µã‚¤ã‚ºãŒ0ã§ã™:', sound.name);\n            return sound;\n          }\n          \n          return { ...sound, audioBlob: blob };\n        } catch (error) {\n          console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:', sound.name, error);\n          return sound;\n        }\n      }\n      return sound;\n    });\n    \n    // æœ‰åŠ¹ãªéŸ³ç´ æã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°\n    const validSounds = soundsWithBlob.filter(sound => {\n      if (!sound.audioBlob) {\n        console.warn('audioBlobãŒå­˜åœ¨ã—ãªã„éŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:', sound.name);\n        return false;\n      }\n      if (!(sound.audioBlob instanceof Blob)) {\n        console.warn('ç„¡åŠ¹ãªBlobå½¢å¼ã®éŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:', sound.name);\n        return false;\n      }\n      if (sound.audioBlob.size === 0) {\n        console.warn('ã‚µã‚¤ã‚ºãŒ0ã®BlobéŸ³ç´ æã‚’ã‚¹ã‚­ãƒƒãƒ—:', sound.name);\n        return false;\n      }\n      return true;\n    });\n    \n    console.log('æœ‰åŠ¹ãªéŸ³ç´ ææ•°:', validSounds.length, '/ ç·æ•°:', soundsWithBlob.length);\n    setSounds(validSounds);\n    \n    // ç„¡åŠ¹ãªéŸ³ç´ æãŒã‚ã£ãŸå ´åˆã¯LocalStorageã‚’æ›´æ–°\n    if (validSounds.length !== soundsWithBlob.length) {\n      console.log('ç„¡åŠ¹ãªéŸ³ç´ æã‚’é™¤å»ã—ã¦LocalStorageã‚’æ›´æ–°');\n      const validSoundsForStorage = validSounds.map(sound => ({\n        ...sound,\n        audioBlob: undefined // Blobã¯ä¿å­˜ã—ãªã„\n      }));\n      localStorage.setItem('soundRecordings', JSON.stringify(validSoundsForStorage));\n    }\n    \n    return () => {\n      if (ctx && ctx.state !== 'closed') {\n        ctx.close().catch(error => {\n          console.warn('åˆæœŸAudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:', error);\n        });\n      }\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      if (dragOverTimeoutRef.current) {\n        clearTimeout(dragOverTimeoutRef.current);\n      }\n      // å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ã™ã¹ã¦åœæ­¢ãƒ»ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      // useEffectå†…ã§playingAudiosã®æœ€æ–°å€¤ã‚’å–å¾—\n      setPlayingAudios(currentPlayingAudios => {\n        currentPlayingAudios.forEach(({ audio, timeoutId, audioUrl }) => {\n          if (timeoutId) {\n            clearTimeout(timeoutId);\n          }\n          if (audio) {\n            audio.pause();\n            audio.src = '';\n          }\n          if (audioUrl) {\n            URL.revokeObjectURL(audioUrl);\n          }\n        });\n        return new Map(); // ç©ºã®Mapã‚’è¿”ã™\n      });\n      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      if (window.currentDraggedSoundBlob) {\n        window.currentDraggedSoundBlob = null;\n      }\n      if (window.currentDraggedSound) {\n        window.currentDraggedSound = null;\n      }\n    };\n  }, []);\n\n  // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¶™ç¶šæ™‚é–“ã‚’å–å¾—ã—ã¦ãƒ”ã‚¯ã‚»ãƒ«å¹…ã«å¤‰æ›\n  const getAudioDuration = useCallback((audioBlob, currentBpm = bpm) => {\n    return new Promise(async (resolve) => {\n      if (!audioBlob || !(audioBlob instanceof Blob)) {\n        console.log('ç„¡åŠ¹ãªaudioBlob - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');\n        resolve(400);\n        return;\n      }\n\n      console.log('audioBlobè©³ç´°:', {\n        size: audioBlob.size,\n        type: audioBlob.type,\n        bpm: currentBpm\n      });\n\n      // AudioContextã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ã‚’å„ªå…ˆ\n      if (audioContext) {\n        try {\n          console.log('AudioContextæ–¹å¼ã§éŸ³å£°é•·ã•ã‚’å–å¾—ä¸­...');\n          const arrayBuffer = await audioBlob.arrayBuffer();\n          const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);\n          const durationInSeconds = audioBuffer.duration;\n          \n          console.log('AudioContextæ–¹å¼ã§å–å¾—ã—ãŸé•·ã•:', durationInSeconds, 'ç§’');\n          \n          if (isFinite(durationInSeconds) && durationInSeconds > 0) {\n            const pixelsPerSecond = (currentBpm / 60) * 100;\n            const widthInPixels = durationInSeconds * pixelsPerSecond;\n            console.log('AudioContextè¨ˆç®—çµæœ - BPM:', currentBpm, 'æ‹/ç§’:', currentBpm/60, 'ãƒ”ã‚¯ã‚»ãƒ«/ç§’:', pixelsPerSecond, 'æœ€çµ‚å¹…:', widthInPixels, 'px');\n            resolve(widthInPixels);\n            return;\n          }\n        } catch (error) {\n          console.log('AudioContextæ–¹å¼ã§ã‚¨ãƒ©ãƒ¼:', error);\n        }\n      }\n\n      // AudioContextãŒå¤±æ•—ã—ãŸå ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨\n      console.log('AudioContextãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');\n      resolve(400);\n    });\n  }, [audioContext, bpm]);\n\n  // ãƒ—ãƒ¬ã‚¤ãƒ˜ãƒƒãƒ‰ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ›´æ–°\n  const updatePlayhead = useCallback(() => {\n    const animate = () => {\n      if (isPlaying && startPlayTime) {\n        const elapsed = (Date.now() - startPlayTime) / 1000; // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰\n        const pixelsPerSecond = (bpm / 60) * 100; // BPMã«åŸºã¥ã„ãŸãƒ”ã‚¯ã‚»ãƒ«/ç§’\n        const newCurrentTime = elapsed * pixelsPerSecond;\n        \n        // æœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\n        if (isFinite(newCurrentTime) && newCurrentTime >= 0) {\n          setCurrentTime(newCurrentTime);\n        } else {\n          console.warn('ç„¡åŠ¹ãªcurrentTime:', newCurrentTime, 'elapsed:', elapsed, 'pixelsPerSecond:', pixelsPerSecond);\n        }\n        \n        // æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¦æ±‚\n        animationFrameRef.current = requestAnimationFrame(animate);\n      }\n    };\n    \n    if (isPlaying && startPlayTime) {\n      animate();\n    }\n  }, [isPlaying, startPlayTime, bpm]);\n\n  useEffect(() => {\n    if (isPlaying) {\n      if (!startPlayTime) {\n        // å†ç”Ÿé–‹å§‹æ™‚ã«startPlayTimeã‚’è¨­å®š\n        const pixelsPerSecond = (bpm / 60) * 100;\n        if (isFinite(pixelsPerSecond) && pixelsPerSecond > 0) {\n          const timeInSeconds = currentTime / pixelsPerSecond;\n          if (isFinite(timeInSeconds) && timeInSeconds >= 0) {\n            setStartPlayTime(Date.now() - (timeInSeconds * 1000));\n          } else {\n            setStartPlayTime(Date.now());\n          }\n        } else {\n          setStartPlayTime(Date.now());\n        }\n      }\n    } else {\n      // å†ç”Ÿåœæ­¢æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n        animationFrameRef.current = null;\n      }\n      setStartPlayTime(null);\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [isPlaying, bpm, currentTime]);\n\n  // startPlayTimeãŒè¨­å®šã•ã‚ŒãŸã¨ãã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹å§‹\n  useEffect(() => {\n    if (isPlaying && startPlayTime) {\n      updatePlayhead();\n    }\n  }, [isPlaying, startPlayTime, updatePlayhead]);\n\n  // BPMå¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼\n  const handleBpmChange = useCallback(async (newBpm) => {\n    setBpm(newBpm);\n    \n    // æ—¢å­˜ã®ã‚¯ãƒªãƒƒãƒ—ã®durationã‚’æ–°ã—ã„BPMã§å†è¨ˆç®—\n    const updatedTracks = await Promise.all(\n      tracks.map(async (track) => {\n        const updatedClips = await Promise.all(\n          track.clips.map(async (clip) => {\n            if (clip.soundData && clip.soundData.audioBlob) {\n              try {\n                const newDuration = await getAudioDuration(clip.soundData.audioBlob, newBpm);\n                return { ...clip, duration: newDuration };\n              } catch (error) {\n                console.warn('ã‚¯ãƒªãƒƒãƒ—ã®durationæ›´æ–°ã«å¤±æ•—:', error);\n                return clip;\n              }\n            }\n            return clip;\n          })\n        );\n        return { ...track, clips: updatedClips };\n      })\n    );\n    \n    setTracks(updatedTracks);\n  }, [tracks, getAudioDuration]);\n\n  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜æ©Ÿèƒ½\n  const saveProject = () => {\n    try {\n      const projectData = {\n        version: '1.0',\n        bpm: bpm,\n        tracks: tracks,\n        sounds: sounds.map(sound => ({\n          ...sound,\n          audioBlob: null, // Blobã¯åˆ¥é€”ä¿å­˜\n          audioData: sound.audioData // base64ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ\n        })),\n        timestamp: Date.now(),\n        trackNameCounter: trackNameCounterRef.current,\n        trackIdCounter: trackIdCounterRef.current\n      };\n\n      const projectJson = JSON.stringify(projectData, null, 2);\n      const blob = new Blob([projectJson], { type: 'application/json' });\n      const url = URL.createObjectURL(blob);\n      \n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `music-project-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n      \n      console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸ');\n    } catch (error) {\n      console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);\n      setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');\n    }\n  };\n\n  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿æ©Ÿèƒ½\n  const loadProject = (event) => {\n    const file = event.target.files[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      try {\n        const projectData = JSON.parse(e.target.result);\n        \n        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯\n        if (!projectData.version) {\n          throw new Error('ä¸æ­£ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');\n        }\n\n        // éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°\n        const restoreAudioBlob = (soundData) => {\n          if (soundData && soundData.audioData) {\n            try {\n              const byteCharacters = atob(soundData.audioData.split(',')[1]);\n              const byteNumbers = new Array(byteCharacters.length);\n              for (let i = 0; i < byteCharacters.length; i++) {\n                byteNumbers[i] = byteCharacters.charCodeAt(i);\n              }\n              const byteArray = new Uint8Array(byteNumbers);\n              const blob = new Blob([byteArray], { type: 'audio/wav' });\n              return { ...soundData, audioBlob: blob };\n            } catch (error) {\n              console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:', soundData.name || 'unknown', error);\n              return soundData;\n            }\n          }\n          return soundData;\n        };\n\n        // BPMã‚’å¾©å…ƒ\n        setBpm(projectData.bpm || 120);\n        \n        // ãƒˆãƒ©ãƒƒã‚¯ã‚’å¾©å…ƒï¼ˆã‚¯ãƒªãƒƒãƒ—å†…ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚‚å¾©å…ƒï¼‰\n        if (projectData.tracks) {\n          const restoredTracks = projectData.tracks.map(track => ({\n            ...track,\n            clips: track.clips\n              .map(clip => ({\n                ...clip,\n                soundData: restoreAudioBlob(clip.soundData)\n              }))\n              .filter(clip => {\n                // ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–\n                if (!clip.soundData || !clip.soundData.name) {\n                  console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:', clip);\n                  return false;\n                }\n                return true;\n              })\n          }));\n          setTracks(restoredTracks);\n          console.log('ãƒˆãƒ©ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', restoredTracks.length, 'ãƒˆãƒ©ãƒƒã‚¯');\n        }\n        \n        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¾©å…ƒ\n        if (projectData.trackNameCounter) {\n          trackNameCounterRef.current = projectData.trackNameCounter;\n        }\n        if (projectData.trackIdCounter) {\n          trackIdCounterRef.current = projectData.trackIdCounter;\n        }\n        \n        // éŸ³ç´ æã‚’å¾©å…ƒï¼ˆæ—¢å­˜ã®éŸ³ç´ æã«è¿½åŠ ï¼‰\n        if (projectData.sounds) {\n          const restoredSounds = projectData.sounds.map(sound => restoreAudioBlob(sound));\n          \n          // æ—¢å­˜ã®éŸ³ç´ æã¨èª­ã¿è¾¼ã‚“ã éŸ³ç´ æã‚’çµåˆ\n          setSounds(prevSounds => {\n            const maxId = prevSounds.length > 0 ? Math.max(...prevSounds.map(s => s.id)) : 0;\n            const existingNames = new Set(prevSounds.map(s => s.name));\n            \n            const newSounds = restoredSounds.map((sound, index) => {\n              let newName = sound.name;\n              let counter = 1;\n              \n              // åå‰ã®é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã€é‡è¤‡ã™ã‚‹å ´åˆã¯ç•ªå·ã‚’ä»˜ã‘ã‚‹\n              while (existingNames.has(newName)) {\n                newName = `${sound.name} (${counter})`;\n                counter++;\n              }\n              existingNames.add(newName);\n              \n              return {\n                ...sound,\n                id: maxId + index + 1, // æ–°ã—ã„IDã‚’å‰²ã‚Šå½“ã¦\n                name: newName // é‡è¤‡ã—ãªã„åå‰ã‚’è¨­å®š\n              };\n            });\n            \n            console.log('éŸ³ç´ æã‚’è¿½åŠ ã—ã¾ã—ãŸ:', newSounds.length, 'å€‹ï¼ˆæ—¢å­˜:', prevSounds.length, 'å€‹ï¼‰');\n            return [...prevSounds, ...newSounds];\n          });\n        }\n        \n        console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');\n        setError(null);\n        \n        // èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°\n        setTimeout(() => {\n          const autoSaveData = {\n            version: '1.0',\n            bpm: projectData.bpm || 120,\n            tracks: projectData.tracks || [],\n            timestamp: Date.now(),\n            trackNameCounter: projectData.trackNameCounter || 1,\n            trackIdCounter: projectData.trackIdCounter || 1\n          };\n          localStorage.setItem('dawProjectAutoSave', JSON.stringify(autoSaveData));\n          console.log('èª­ã¿è¾¼ã¿å¾Œã®è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');\n        }, 100);\n      } catch (error) {\n        console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);\n        setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');\n      }\n    };\n    \n    reader.readAsText(file);\n    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ\n    event.target.value = '';\n  };\n\n  // éŸ³æºå‡ºåŠ›æ©Ÿèƒ½\n  const exportAudio = async () => {\n    if (!audioContext) {\n      setError('AudioContextãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');\n      return;\n    }\n\n    setIsExporting(true);\n    try {\n      // å…¨ãƒˆãƒ©ãƒƒã‚¯ã®å…¨ã‚¯ãƒªãƒƒãƒ—ã®æœ€å¤§çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—\n      let maxDuration = 0;\n      tracks.forEach(track => {\n        track.clips.forEach(clip => {\n          const pixelsPerSecond = (bpm / 60) * 100;\n          const clipStartTimeInSeconds = clip.startTime / pixelsPerSecond;\n          const clipDurationInSeconds = clip.duration / pixelsPerSecond;\n          const clipEndTime = clipStartTimeInSeconds + clipDurationInSeconds;\n          maxDuration = Math.max(maxDuration, clipEndTime);\n        });\n      });\n\n      if (maxDuration === 0) {\n        setError('å‡ºåŠ›ã™ã‚‹éŸ³å£°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚éŸ³ç´ æã‚’é…ç½®ã—ã¦ãã ã•ã„ã€‚');\n        setIsExporting(false);\n        return;\n      }\n\n      // å‡ºåŠ›ç”¨AudioContextã‚’ä½œæˆï¼ˆ44.1kHzï¼‰\n      const exportContext = new AudioContext({ sampleRate: 44100 });\n      const bufferLength = Math.ceil(maxDuration * exportContext.sampleRate);\n      const outputBuffer = exportContext.createBuffer(2, bufferLength, exportContext.sampleRate);\n      \n      const leftChannel = outputBuffer.getChannelData(0);\n      const rightChannel = outputBuffer.getChannelData(1);\n\n      // å„ãƒˆãƒ©ãƒƒã‚¯ã®å„ã‚¯ãƒªãƒƒãƒ—ã‚’å‡¦ç†\n      for (const track of tracks) {\n        for (const clip of track.clips) {\n          if (clip.soundData && clip.soundData.audioBlob) {\n            try {\n              const arrayBuffer = await clip.soundData.audioBlob.arrayBuffer();\n              const audioBuffer = await exportContext.decodeAudioData(arrayBuffer);\n              \n              const pixelsPerSecond = (bpm / 60) * 100;\n              const startTimeInSamples = Math.floor((clip.startTime / pixelsPerSecond) * exportContext.sampleRate);\n              \n              // éŸ³å£°ã‚’ãƒŸãƒƒã‚¯ã‚¹\n              for (let channel = 0; channel < Math.min(audioBuffer.numberOfChannels, 2); channel++) {\n                const sourceData = audioBuffer.getChannelData(channel);\n                const targetData = channel === 0 ? leftChannel : rightChannel;\n                \n                for (let i = 0; i < sourceData.length && (startTimeInSamples + i) < targetData.length; i++) {\n                  targetData[startTimeInSamples + i] += sourceData[i];\n                }\n              }\n              \n              // ãƒ¢ãƒãƒ©ãƒ«éŸ³æºã®å ´åˆã¯ä¸¡ãƒãƒ£ãƒ³ãƒãƒ«ã«ã‚³ãƒ”ãƒ¼\n              if (audioBuffer.numberOfChannels === 1) {\n                const sourceData = audioBuffer.getChannelData(0);\n                for (let i = 0; i < sourceData.length && (startTimeInSamples + i) < rightChannel.length; i++) {\n                  rightChannel[startTimeInSamples + i] += sourceData[i];\n                }\n              }\n            } catch (error) {\n              console.error('ã‚¯ãƒªãƒƒãƒ—ã®å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);\n            }\n          }\n        }\n      }\n\n      // WAVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›\n      const wavBlob = audioBufferToWav(outputBuffer);\n      const url = URL.createObjectURL(wavBlob);\n      \n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `exported-music-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.wav`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      URL.revokeObjectURL(url);\n      \n      console.log('éŸ³æºã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');\n      if (exportContext && exportContext.state !== 'closed') {\n        await exportContext.close().catch(error => {\n          console.warn('Export AudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:', error);\n        });\n      }\n    } catch (error) {\n      console.error('éŸ³æºå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);\n      setError('éŸ³æºã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');\n    } finally {\n      setIsExporting(false);\n    }\n  };\n\n  // AudioBufferã‚’WAVãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›\n  const audioBufferToWav = (buffer) => {\n    const length = buffer.length;\n    const numberOfChannels = buffer.numberOfChannels;\n    const sampleRate = buffer.sampleRate;\n    const bytesPerSample = 2;\n    const blockAlign = numberOfChannels * bytesPerSample;\n    const byteRate = sampleRate * blockAlign;\n    const dataSize = length * blockAlign;\n    const bufferSize = 44 + dataSize;\n    \n    const arrayBuffer = new ArrayBuffer(bufferSize);\n    const view = new DataView(arrayBuffer);\n    \n    // WAVãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼\n    const writeString = (offset, string) => {\n      for (let i = 0; i < string.length; i++) {\n        view.setUint8(offset + i, string.charCodeAt(i));\n      }\n    };\n    \n    writeString(0, 'RIFF');\n    view.setUint32(4, bufferSize - 8, true);\n    writeString(8, 'WAVE');\n    writeString(12, 'fmt ');\n    view.setUint32(16, 16, true);\n    view.setUint16(20, 1, true);\n    view.setUint16(22, numberOfChannels, true);\n    view.setUint32(24, sampleRate, true);\n    view.setUint32(28, byteRate, true);\n    view.setUint16(32, blockAlign, true);\n    view.setUint16(34, bytesPerSample * 8, true);\n    writeString(36, 'data');\n    view.setUint32(40, dataSize, true);\n    \n    // éŸ³å£°ãƒ‡ãƒ¼ã‚¿\n    let offset = 44;\n    for (let i = 0; i < length; i++) {\n      for (let channel = 0; channel < numberOfChannels; channel++) {\n        const sample = buffer.getChannelData(channel)[i];\n        const intSample = Math.max(-1, Math.min(1, sample)) * 0x7FFF;\n        view.setInt16(offset, intSample, true);\n        offset += 2;\n      }\n    }\n    \n    return new Blob([arrayBuffer], { type: 'audio/wav' });\n  };\n\n  const addTrack = () => {\n    // ã‚ˆã‚Šç¢ºå®Ÿã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ\n    trackIdCounterRef.current += 1;\n    const uniqueId = Date.now() + trackIdCounterRef.current;\n    \n    // ãƒˆãƒ©ãƒƒã‚¯åã®ç•ªå·ã‚’å¢—åŠ ï¼ˆå‰Šé™¤ã•ã‚Œã¦ã‚‚ç•ªå·ã¯æˆ»ã‚‰ãªã„ï¼‰\n    trackNameCounterRef.current += 1;\n    const trackName = `ãƒˆãƒ©ãƒƒã‚¯ ${trackNameCounterRef.current}`;\n    \n    const newTrack = {\n      id: uniqueId,\n      name: trackName,\n      clips: []\n    };\n    setTracks(prevTracks => [...prevTracks, newTrack]);\n  };\n\n  const removeTrack = (trackId) => {\n    setTracks(prevTracks => {\n      if (prevTracks.length > 1) {\n        return prevTracks.filter(track => track.id !== trackId);\n      }\n      return prevTracks;\n    });\n  };\n\n  const handleDrop = async (e, trackId, timePosition) => {\n    e.preventDefault();\n    setDragPreview(null);\n    \n    console.log('ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†é–‹å§‹:', { trackId, timePosition, draggedClip });\n    \n    try {\n      \n      // æ—¢å­˜ã®ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯\n      if (draggedClip) {\n        console.log('æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•:', draggedClip.id, 'å…ƒãƒˆãƒ©ãƒƒã‚¯:', draggedClip.originalTrackId, 'æ–°ãƒˆãƒ©ãƒƒã‚¯:', trackId);\n        console.log('ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆ:', dragOffset, 'ãƒã‚¦ã‚¹ä½ç½®:', timePosition);\n        \n        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®ã—ãŸæ–°ã—ã„é–‹å§‹ä½ç½®ã‚’è¨ˆç®—\n        const adjustedPosition = timePosition - dragOffset;\n        // 8åˆ†éŸ³ç¬¦ã«åˆã‚ã›ã¦ä½ç½®ã‚’èª¿æ•´ï¼ˆ50pxå˜ä½ï¼‰\n        const snappedPosition = Math.max(0, Math.round(adjustedPosition / SUB_BEAT_WIDTH) * SUB_BEAT_WIDTH);\n        \n        console.log('èª¿æ•´å¾Œã®ä½ç½®:', adjustedPosition, 'ã‚¹ãƒŠãƒƒãƒ—å¾Œ:', snappedPosition);\n        \n        // æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•\n        const updatedClip = {\n          ...draggedClip,\n          startTime: snappedPosition,\n          trackId: trackId\n        };\n\n        setTracks(prevTracks => prevTracks.map(track => {\n          if (track.id === draggedClip.originalTrackId && track.id === trackId) {\n            // åŒã˜ãƒˆãƒ©ãƒƒã‚¯å†…ã§ã®ç§»å‹•\n            console.log('åŒã˜ãƒˆãƒ©ãƒƒã‚¯å†…ã§ã®ç§»å‹•');\n            return {\n              ...track,\n              clips: track.clips.map(clip => \n                clip.id === draggedClip.id ? updatedClip : clip\n              )\n            };\n          } else if (track.id === draggedClip.originalTrackId) {\n            // å…ƒã®ãƒˆãƒ©ãƒƒã‚¯ã‹ã‚‰ã‚¯ãƒªãƒƒãƒ—ã‚’å‰Šé™¤\n            console.log('å…ƒã®ãƒˆãƒ©ãƒƒã‚¯ã‹ã‚‰ã‚¯ãƒªãƒƒãƒ—ã‚’å‰Šé™¤');\n            return {\n              ...track,\n              clips: track.clips.filter(clip => clip.id !== draggedClip.id)\n            };\n          } else if (track.id === trackId) {\n            // æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã«ã‚¯ãƒªãƒƒãƒ—ã‚’è¿½åŠ \n            console.log('æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã«ã‚¯ãƒªãƒƒãƒ—ã‚’è¿½åŠ ');\n            return {\n              ...track,\n              clips: [...track.clips, updatedClip]\n            };\n          }\n          return track;\n        }));\n        setDraggedClip(null);\n        setDragOffset(0);\n        return;\n      }\n      \n      // æ–°ã—ã„éŸ³ç´ æã®é…ç½®\n      let soundData;\n      try {\n        // dataTransferã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—\n        const jsonData = e.dataTransfer ? e.dataTransfer.getData('application/json') : '';\n        if (jsonData) {\n          soundData = JSON.parse(jsonData);\n        } else {\n          // ãƒ¢ãƒã‚¤ãƒ«ã®å ´åˆã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰å–å¾—\n          soundData = window.currentDraggedSound;\n        }\n      } catch (error) {\n        console.error('ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);\n        soundData = window.currentDraggedSound; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯\n      }\n      \n      if (!soundData) {\n        console.error('éŸ³ç´ æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');\n        setError('éŸ³ç´ æãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');\n        return;\n      }\n\n      // soundDataã®å¿…è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ãƒã‚§ãƒƒã‚¯\n      if (!soundData.name) {\n        console.error('éŸ³ç´ æã®åå‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', soundData);\n        setError('éŸ³ç´ æã®åå‰ãŒä¸æ­£ã§ã™ã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');\n        return;\n      }\n      \n      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰audioBlobã‚’å¾©å…ƒ\n      if (window.currentDraggedSoundBlob) {\n        soundData.audioBlob = window.currentDraggedSoundBlob;\n        window.currentDraggedSoundBlob = null; // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      }\n      \n      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢\n      window.currentDraggedSound = null;\n      \n      console.log('æ–°ã—ã„éŸ³ç´ æã®ãƒ‰ãƒ­ãƒƒãƒ—:', { soundData, hasAudioBlob: !!soundData.audioBlob });\n      \n      // éŸ³å£°ã®å®Ÿéš›ã®ç¶™ç¶šæ™‚é–“ã‚’å–å¾—ï¼ˆç¾åœ¨ã®BPMã«åŸºã¥ã„ã¦ï¼‰\n      let duration = 400; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ1å°ç¯€ï¼‰\n      if (soundData.audioBlob) {\n        try {\n          duration = await getAudioDuration(soundData.audioBlob, bpm);\n          console.log('å–å¾—ã—ãŸduration:', duration, 'pixels (BPM:', bpm, ')');\n        } catch (error) {\n          console.warn('éŸ³å£°ç¶™ç¶šæ™‚é–“ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);\n        }\n      }\n\n      // durationãŒæœ‰åŠ¹ãªå€¤ã‹ãƒã‚§ãƒƒã‚¯\n      if (!isFinite(duration) || duration <= 0) {\n        console.warn('ç„¡åŠ¹ãªduration:', duration, 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨');\n        duration = 400; // 1å°ç¯€åˆ†\n      }\n\n      // æ–°ã—ã„éŸ³ç´ æã®å ´åˆã¯é€šå¸¸ã®ã‚¹ãƒŠãƒƒãƒ—å‡¦ç†\n      const snappedPosition = Math.round(timePosition / SUB_BEAT_WIDTH) * SUB_BEAT_WIDTH;\n\n      const newClip = {\n        id: Date.now() + Math.random(), // ã‚ˆã‚Šç¢ºå®Ÿã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ\n        soundData: soundData,\n        startTime: snappedPosition,\n        duration: duration,\n        trackId: trackId\n      };\n\n      console.log('ä½œæˆã•ã‚ŒãŸã‚¯ãƒªãƒƒãƒ—:', newClip);\n      console.log('ç¾åœ¨ã®ãƒˆãƒ©ãƒƒã‚¯æ•°:', tracks.length);\n      console.log('å¯¾è±¡ãƒˆãƒ©ãƒƒã‚¯ID:', trackId);\n      console.log('å¯¾è±¡ãƒˆãƒ©ãƒƒã‚¯:', tracks.find(t => t.id === trackId));\n\n      // é–¢æ•°å‹æ›´æ–°ã‚’ä½¿ç”¨ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«å–å¾—\n      setTracks(prevTracks => {\n        console.log('æ›´æ–°å‰ã®ãƒˆãƒ©ãƒƒã‚¯:', prevTracks.find(t => t.id === trackId));\n        const updatedTracks = prevTracks.map(track => \n          track.id === trackId \n            ? { ...track, clips: [...track.clips, newClip] }\n            : track\n        );\n        console.log('æ›´æ–°å¾Œã®ãƒˆãƒ©ãƒƒã‚¯:', updatedTracks.find(t => t.id === trackId));\n        return updatedTracks;\n      });\n    } catch (error) {\n      console.error('ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);\n      setError('éŸ³ç´ æã®é…ç½®ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');\n    }\n  };\n\n  const handleDragOver = (e) => {\n    e.preventDefault();\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°ã•ã‚Œã¦ã„ã‚‹ã®ãŒæ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã‹æ–°ã—ã„éŸ³ç´ æã‹ã§å‡¦ç†ã‚’åˆ†ã‘ã‚‹\n    if (draggedClip) {\n      e.dataTransfer.dropEffect = 'move';\n    } else {\n      e.dataTransfer.dropEffect = 'copy';\n    }\n    \n    // ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚° - 16msï¼ˆ60FPSï¼‰é–“éš”ã§å®Ÿè¡Œã‚’åˆ¶é™\n    if (dragOverTimeoutRef.current) {\n      return;\n    }\n    \n    // å¿…è¦ãªæƒ…å ±ã‚’äº‹å‰ã«æŠ½å‡º\n    const clientX = e.clientX;\n    const currentTarget = e.currentTarget;\n    \n    dragOverTimeoutRef.current = setTimeout(() => {\n      dragOverTimeoutRef.current = null;\n      updateDragPreview(clientX, currentTarget);\n    }, 16);\n  };\n  \n  const updateDragPreview = (clientX, trackElement) => {\n    // null ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ \n    if (!trackElement || !timelineRef.current) {\n      return;\n    }\n\n    // åˆå›ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºæ™‚ã«å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚’è¨­å®š\n    if (!window.dragCleanupTimer) {\n      console.log('å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼è¨­å®šï¼ˆ10ç§’å¾Œï¼‰');\n      window.dragCleanupTimer = setTimeout(() => {\n        console.log('å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼å®Ÿè¡Œ');\n        cleanupDragState();\n      }, 10000); // 10ç§’å¾Œã«å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    }\n    \n    try {\n      // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°\n      const rect = trackElement.getBoundingClientRect();\n      const timePosition = clientX - rect.left;\n      \n      let snappedPosition;\n      \n      if (draggedClip) {\n        // æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®å ´åˆï¼šãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è€ƒæ…®\n        const adjustedPosition = timePosition - dragOffset;\n        snappedPosition = Math.max(0, Math.round(adjustedPosition / SUB_BEAT_WIDTH) * SUB_BEAT_WIDTH);\n      } else {\n        // æ–°ã—ã„éŸ³ç´ æã®å ´åˆï¼šé€šå¸¸ã®å‡¦ç†\n        snappedPosition = Math.round(timePosition / SUB_BEAT_WIDTH) * SUB_BEAT_WIDTH;\n      }\n      \n      const trackRect = trackElement.getBoundingClientRect();\n      const tracksAreaRect = timelineRef.current.getBoundingClientRect();\n      \n      if (tracksAreaRect && trackElement.dataset && trackElement.dataset.trackId) {\n        const relativeTop = trackRect.top - tracksAreaRect.top;\n        const trackId = parseInt(trackElement.dataset.trackId);\n        \n        // trackIdãŒæœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\n        if (isNaN(trackId)) {\n          return;\n        }\n        \n        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¹…ã‚’æ±ºå®š\n        let previewWidth = 400; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆ1å°ç¯€ï¼‰\n        \n        if (draggedClip) {\n          // æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®å ´åˆ\n          previewWidth = isFinite(draggedClip.duration) && draggedClip.duration > 0 \n            ? draggedClip.duration \n            : 400;\n        } else {\n          // æ–°ã—ã„éŸ³ç´ æã®å ´åˆã€äº‹å‰ã«è¨ˆç®—ã•ã‚ŒãŸé•·ã•ã‚’ä½¿ç”¨\n          previewWidth = draggedSoundDuration;\n        }\n        \n        setDragPreview({\n          left: snappedPosition,\n          top: relativeTop + 10,\n          width: previewWidth,\n          trackId: trackId\n        });\n      }\n    } catch (error) {\n      console.warn('ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);\n      // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢\n      setDragPreview(null);\n    }\n  };\n\n  const removeClip = (trackId, clipId) => {\n    setTracks(prevTracks => prevTracks.map(track => \n      track.id === trackId \n        ? { ...track, clips: track.clips.filter(clip => clip.id !== clipId) }\n        : track\n    ));\n  };\n\n  // ã‚¯ãƒªãƒƒãƒ—ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹\n  const handleClipDragStart = (clip, originalTrackId, mouseX, clipElement) => {\n    console.log('ã‚¯ãƒªãƒƒãƒ—ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹:', clip.id, 'ãƒˆãƒ©ãƒƒã‚¯:', originalTrackId);\n    \n    // ã‚¯ãƒªãƒƒãƒ—å†…ã§ã®ãƒã‚¦ã‚¹ä½ç½®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’è¨ˆç®—\n    const clipRect = clipElement.getBoundingClientRect();\n    const offsetInClip = mouseX - clipRect.left;\n    \n    console.log('ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ•ã‚»ãƒƒãƒˆ:', offsetInClip, 'ã‚¯ãƒªãƒƒãƒ—é–‹å§‹ä½ç½®:', clip.startTime);\n    \n    setDraggedClip({ ...clip, originalTrackId });\n    setDragOffset(offsetInClip);\n  };\n\n  // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®å®Œå…¨ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n  const cleanupDragState = useCallback(() => {\n    console.log('ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œ');\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢\n    if (dragOverTimeoutRef.current) {\n      clearTimeout(dragOverTimeoutRef.current);\n      dragOverTimeoutRef.current = null;\n    }\n    \n    // å¼·åˆ¶ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢\n    if (window.dragCleanupTimer) {\n      clearTimeout(window.dragCleanupTimer);\n      window.dragCleanupTimer = null;\n    }\n    \n    // ã™ã¹ã¦ã®ãƒ‰ãƒ©ãƒƒã‚°é–¢é€£ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ\n    setDraggedClip(null);\n    setDragPreview(null);\n    setDraggedSoundDuration(400);\n    setDragOffset(0);\n    \n    // DOMè¦ç´ ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    document.querySelectorAll('.track').forEach(track => {\n      track.classList.remove('drag-over');\n    });\n    \n    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤\n    const mobileDragPreview = document.querySelector('.mobile-drag-preview');\n    if (mobileDragPreview) {\n      mobileDragPreview.remove();\n    }\n    \n    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    if (window.currentDraggedSoundBlob) {\n      window.currentDraggedSoundBlob = null;\n    }\n    if (window.currentDraggedSound) {\n      window.currentDraggedSound = null;\n    }\n    \n    // ãƒœãƒ‡ã‚£ã‚¯ãƒ©ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    document.body.classList.remove('dragging');\n  }, []);\n\n  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒã‚¦ãƒ³ãƒˆæ™‚ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š\n  useEffect(() => {\n    window.cleanupDragStateCallback = cleanupDragState;\n    \n    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ \n    const handleGlobalDragEnd = () => {\n      console.log('ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆæ¤œå‡º');\n      cleanupDragState();\n    };\n\n    const handleGlobalDragLeave = (e) => {\n      // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤–ã«ãƒ‰ãƒ©ãƒƒã‚°ãŒå‡ºãŸå ´åˆ\n      if (!e.relatedTarget || e.relatedTarget.nodeName === 'HTML') {\n        console.log('ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå¤–ã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ã‚¦ãƒˆ');\n        cleanupDragState();\n      }\n    };\n\n    // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š\n    document.addEventListener('dragend', handleGlobalDragEnd);\n    document.addEventListener('dragleave', handleGlobalDragLeave);\n    \n    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°\n    return () => {\n      if (window.cleanupDragStateCallback === cleanupDragState) {\n        window.cleanupDragStateCallback = null;\n      }\n      document.removeEventListener('dragend', handleGlobalDragEnd);\n      document.removeEventListener('dragleave', handleGlobalDragLeave);\n    };\n  }, [cleanupDragState]);\n\n  // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n  const handleDragEnd = (e) => {\n    // ãƒ‰ãƒ­ãƒƒãƒ—ãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œãªã‹ã£ãŸå ´åˆã€å…ƒã®çŠ¶æ…‹ã‚’ä¿æŒ\n    if (draggedClip && e && e.dataTransfer && e.dataTransfer.dropEffect === 'none') {\n      console.log('ãƒ‰ãƒ©ãƒƒã‚°ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚å…ƒã®ä½ç½®ã‚’ä¿æŒã—ã¾ã™ã€‚');\n    }\n    \n    // å®Œå…¨ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    cleanupDragState();\n  };\n\n  const play = async () => {\n    try {\n      // AudioContextãŒä¸­æ–­ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†é–‹\n      if (audioContext && audioContext.state === 'suspended') {\n        await audioContext.resume();\n      }\n      \n      setIsPlaying(true);\n      \n      // ç¾åœ¨ã®æ™‚é–“ä½ç½®ã«åŸºã¥ã„ã¦ã€å†ç”Ÿã™ã¹ãã‚¯ãƒªãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã‚‹\n      const pixelsPerSecond = (bpm / 60) * 100;\n      const currentTimeInSeconds = currentTime / pixelsPerSecond;\n      \n      // å„ãƒˆãƒ©ãƒƒã‚¯ã®ã‚¯ãƒªãƒƒãƒ—ã‚’å†ç”Ÿ\n      const newPlayingAudios = new Map();\n      \n      tracks.forEach(track => {\n        track.clips.forEach(clip => {\n          // clip.durationãŒæœ‰åŠ¹ãªå€¤ã‹ãƒã‚§ãƒƒã‚¯\n          if (!isFinite(clip.duration) || clip.duration <= 0) {\n            console.warn('ç„¡åŠ¹ãªclip.duration:', clip.duration, 'ã‚¯ãƒªãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™');\n            return;\n          }\n          \n          const clipStartTimeInSeconds = clip.startTime / pixelsPerSecond;\n          const clipEndTimeInSeconds = clipStartTimeInSeconds + (clip.duration / pixelsPerSecond);\n          \n          // è¨ˆç®—çµæœãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯\n          if (!isFinite(clipStartTimeInSeconds) || !isFinite(clipEndTimeInSeconds)) {\n            console.warn('ç„¡åŠ¹ãªæ™‚é–“è¨ˆç®—:', { clipStartTimeInSeconds, clipEndTimeInSeconds });\n            return;\n          }\n          \n          // ç¾åœ¨ã®æ™‚é–“ä½ç½®ãŒã‚¯ãƒªãƒƒãƒ—ã®ç¯„å›²å†…ã¾ãŸã¯ä»Šå¾Œå†ç”Ÿã•ã‚Œã‚‹å ´åˆ\n          if (clipEndTimeInSeconds > currentTimeInSeconds) {\n            const delay = Math.max(0, clipStartTimeInSeconds - currentTimeInSeconds);\n            if (isFinite(delay) && delay >= 0) {\n              scheduleClipPlayback(clip, delay * 1000, newPlayingAudios);\n            }\n          }\n        });\n      });\n      \n      setPlayingAudios(newPlayingAudios);\n    } catch (error) {\n      console.error('å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);\n      setError('éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã§éŸ³å£°ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚');\n    }\n  };\n\n  const scheduleClipPlayback = (clip, delayMs, playingAudiosMap) => {\n    console.log('scheduleClipPlayback:', { clip, hasAudioBlob: !!clip.soundData?.audioBlob });\n    \n    if (clip.soundData && clip.soundData.audioBlob && clip.soundData.audioBlob instanceof Blob) {\n      try {\n        const audio = new Audio();\n        const audioUrl = URL.createObjectURL(clip.soundData.audioBlob);\n        audio.src = audioUrl;\n        \n        const timeoutId = setTimeout(() => {\n          audio.play().catch(error => {\n            console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);\n            URL.revokeObjectURL(audioUrl); // ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã‚’é˜²ã\n          });\n        }, delayMs);\n        \n        // éŸ³å£°çµ‚äº†æ™‚ã«URLã‚’è§£æ”¾\n        audio.addEventListener('ended', () => {\n          URL.revokeObjectURL(audioUrl);\n        });\n        \n        playingAudiosMap.set(clip.id, { audio, timeoutId, audioUrl });\n      } catch (error) {\n        console.error('createObjectURL ã‚¨ãƒ©ãƒ¼:', error, 'audioBlob:', clip.soundData.audioBlob);\n      }\n    } else {\n      console.warn('audioBlobãŒç„¡åŠ¹ã§ã™ã€‚ã‚¯ãƒªãƒƒãƒ—æƒ…å ±:', {\n        clipId: clip.id,\n        soundDataName: clip.soundData?.name,\n        hasAudioData: !!clip.soundData?.audioData,\n        hasAudioBlob: !!clip.soundData?.audioBlob,\n        audioBlobType: typeof clip.soundData?.audioBlob,\n        isInstanceOfBlob: clip.soundData?.audioBlob instanceof Blob\n      });\n      \n      // AudioBlobãŒç„¡åŠ¹ãªå ´åˆã€audioDataã‹ã‚‰å¾©å…ƒã‚’è©¦è¡Œ\n      if (clip.soundData && clip.soundData.audioData && !clip.soundData.audioBlob) {\n        console.log('audioDataã‹ã‚‰Blobã‚’å†ä½œæˆä¸­...');\n        try {\n          const byteCharacters = atob(clip.soundData.audioData.split(',')[1]);\n          const byteNumbers = new Array(byteCharacters.length);\n          for (let i = 0; i < byteCharacters.length; i++) {\n            byteNumbers[i] = byteCharacters.charCodeAt(i);\n          }\n          const byteArray = new Uint8Array(byteNumbers);\n          const blob = new Blob([byteArray], { type: 'audio/wav' });\n          \n          // ã‚¯ãƒªãƒƒãƒ—ã®soundDataã‚’æ›´æ–°\n          clip.soundData.audioBlob = blob;\n          \n          // å†å¸°çš„ã«å†è©¦è¡Œ\n          scheduleClipPlayback(clip, delayMs, playingAudiosMap);\n          return;\n        } catch (restoreError) {\n          console.error('audioDataã‹ã‚‰ã®Blobå¾©å…ƒã«å¤±æ•—:', restoreError);\n        }\n      }\n    }\n  };\n\n  const pause = () => {\n    setIsPlaying(false);\n    \n    // å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ä¸€æ™‚åœæ­¢\n    playingAudios.forEach(({ audio, timeoutId, audioUrl }) => {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      if (!audio.paused) {\n        audio.pause();\n      }\n      // URLã‚’è§£æ”¾\n      if (audioUrl) {\n        URL.revokeObjectURL(audioUrl);\n      }\n    });\n  };\n\n  const stop = () => {\n    setIsPlaying(false);\n    setCurrentTime(0);\n    \n    // å†ç”Ÿä¸­ã®éŸ³å£°ã‚’åœæ­¢\n    playingAudios.forEach(({ audio, timeoutId, audioUrl }) => {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      audio.pause();\n      audio.currentTime = 0;\n      // URLã‚’è§£æ”¾\n      if (audioUrl) {\n        URL.revokeObjectURL(audioUrl);\n      }\n    });\n    \n    setPlayingAudios(new Map());\n  };\n\n  // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ä¿å­˜æ©Ÿèƒ½\n  useEffect(() => {\n    const autoSaveProject = () => {\n      try {\n        const projectData = {\n          version: '1.0',\n          bpm: bpm,\n          tracks: tracks,\n          timestamp: Date.now(),\n          trackNameCounter: trackNameCounterRef.current,\n          trackIdCounter: trackIdCounterRef.current\n        };\n\n        localStorage.setItem('dawProjectAutoSave', JSON.stringify(projectData));\n        console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ:', {\n          tracksCount: tracks.length,\n          bpm: bpm,\n          totalClips: tracks.reduce((total, track) => total + track.clips.length, 0)\n        });\n      } catch (error) {\n        console.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è‡ªå‹•ä¿å­˜ã«å¤±æ•—:', error);\n      }\n    };\n\n    // åˆæœŸåŒ–å¾Œã®è‡ªå‹•ä¿å­˜ï¼ˆtracksã‚„bpmãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ï¼‰\n    if (tracks.length > 0) {\n      autoSaveProject();\n    }\n  }, [tracks, bpm]);\n\n  // éŸ³ç´ æã®æ›´æ–°ç›£è¦–ï¼ˆä»–ã®ãƒšãƒ¼ã‚¸ã§éŸ³ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆã®å¯¾å¿œï¼‰\n  useEffect(() => {\n    const handleVisibilityChange = () => {\n      if (!document.hidden) {\n        // ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«éŸ³ç´ æã‚’å†èª­ã¿è¾¼ã¿\n        const savedSounds = JSON.parse(localStorage.getItem('soundRecordings') || '[]');\n        console.log('ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®éŸ³ç´ æå†èª­ã¿è¾¼ã¿ - ä»¶æ•°:', savedSounds.length);\n        \n        // éŸ³å£°ãƒ‡ãƒ¼ã‚¿å¾©å…ƒå‡¦ç†ï¼ˆæ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†åˆ©ç”¨ï¼‰\n        const soundsWithBlob = savedSounds.map(sound => {\n          if (sound.audioData) {\n            try {\n              const base64Data = sound.audioData.split(',')[1];\n              if (!base64Data || base64Data.length === 0) {\n                return sound;\n              }\n              \n              const byteCharacters = atob(base64Data);\n              const byteNumbers = new Array(byteCharacters.length);\n              for (let i = 0; i < byteCharacters.length; i++) {\n                byteNumbers[i] = byteCharacters.charCodeAt(i);\n              }\n              const byteArray = new Uint8Array(byteNumbers);\n              const blob = new Blob([byteArray], { type: 'audio/wav' });\n              \n              return { ...sound, audioBlob: blob };\n            } catch (error) {\n              console.error('éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒã«å¤±æ•—:', sound.name, error);\n              return sound;\n            }\n          }\n          return sound;\n        });\n        \n        const validSounds = soundsWithBlob.filter(sound => \n          sound.audioBlob && sound.audioBlob instanceof Blob && sound.audioBlob.size > 0\n        );\n        \n        setSounds(validSounds);\n        console.log('éŸ³ç´ ææ›´æ–°å®Œäº† - æœ‰åŠ¹ä»¶æ•°:', validSounds.length);\n      }\n    };\n\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    \n    return () => {\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\n    };\n  }, []);\n\n  // è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹æ©Ÿèƒ½\n  const clearAutoSave = () => {\n    try {\n      localStorage.removeItem('dawProjectAutoSave');\n      console.log('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');\n      \n      // åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ\n      setTracks([{ \n        id: Date.now(), \n        name: 'ãƒˆãƒ©ãƒƒã‚¯ 1', \n        clips: [] \n      }]);\n      setBpm(120);\n      trackNameCounterRef.current = 1;\n      trackIdCounterRef.current = 1;\n      \n      setError(null);\n      alert('âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');\n    } catch (error) {\n      console.error('è‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢ã«å¤±æ•—:', error);\n      setError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');\n    }\n  };\n\n  // ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–ã™ã‚‹é–¢æ•°\n  const cleanupInvalidClips = () => {\n    setTracks(prevTracks => {\n      const cleanedTracks = prevTracks.map(track => ({\n        ...track,\n        clips: track.clips.filter(clip => {\n          if (!clip.soundData || !clip.soundData.name) {\n            console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–:', clip);\n            return false;\n          }\n          return true;\n        })\n      }));\n      \n      const removedCount = prevTracks.reduce((total, track) => total + track.clips.length, 0) - \n                          cleanedTracks.reduce((total, track) => total + track.clips.length, 0);\n      \n      if (removedCount > 0) {\n        console.log(`${removedCount}å€‹ã®ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’é™¤å¤–ã—ã¾ã—ãŸ`);\n      }\n      \n      return cleanedTracks;\n    });\n  };\n\n  // åˆæœŸåŒ–æ™‚ã«ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n  useEffect(() => {\n    const timer = setTimeout(() => {\n      cleanupInvalidClips();\n    }, 1000); // 1ç§’å¾Œã«å®Ÿè¡Œ\n\n    return () => clearTimeout(timer);\n  }, []);\n\n  // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆæ™‚ã®åŒ…æ‹¬çš„ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n  useEffect(() => {\n    return () => {\n      // ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      cleanupDragState();\n      \n      // å†ç”Ÿä¸­ã®éŸ³å£°ã‚’ã™ã¹ã¦åœæ­¢\n      setPlayingAudios(currentPlayingAudios => {\n        currentPlayingAudios.forEach(({ audio, timeoutId, audioUrl }) => {\n          if (timeoutId) {\n            clearTimeout(timeoutId);\n          }\n          if (audio) {\n            audio.pause();\n            audio.src = '';\n          }\n          if (audioUrl) {\n            URL.revokeObjectURL(audioUrl);\n          }\n        });\n        return new Map();\n      });\n      \n      // AudioContextã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n      if (audioContext && audioContext.state !== 'closed') {\n        audioContext.close().catch(error => {\n          console.warn('AudioContext ã®ã‚¯ãƒ­ãƒ¼ã‚ºã«å¤±æ•—:', error);\n        });\n      }\n      \n      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢\n      if (animationFrameRef.current) {\n        cancelAnimationFrame(animationFrameRef.current);\n      }\n      \n      // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢\n      if (dragOverTimeoutRef.current) {\n        clearTimeout(dragOverTimeoutRef.current);\n      }\n    };\n  }, [cleanupDragState, audioContext]);\n\n  return (\n    <div className=\"daw-page\">\n      <h2>ğŸ¹ éŸ³æ¥½ã¥ãã‚Šãƒšãƒ¼ã‚¸</h2>\n      <p>éŸ³ç´ æã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦éŸ³æ¥½ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>\n\n      {error && (\n        <div className=\"error-message\">\n          <span>âš ï¸ {error}</span>\n          <button onClick={() => setError(null)}>Ã—</button>\n        </div>\n      )}\n\n      <div className=\"daw-controls card\">\n        <div className=\"transport-controls\">\n          <button \n            className={`transport-btn play-btn ${isPlaying ? 'playing' : ''}`}\n            onClick={isPlaying ? pause : play}\n          >\n            {isPlaying ? 'â¸ï¸' : 'â–¶ï¸'}\n          </button>\n          <button className=\"transport-btn stop-btn\" onClick={stop}>\n            â¹ï¸\n          </button>\n        </div>\n\n        <div className=\"bpm-control\">\n          <label htmlFor=\"bpm\">ğŸµ BPM:</label>\n          <input\n            id=\"bpm\"\n            type=\"number\"\n            value={bpm}\n            onChange={(e) => handleBpmChange(parseInt(e.target.value))}\n            min=\"60\"\n            max=\"200\"\n            className=\"bpm-input\"\n          />\n        </div>\n\n        <div className=\"track-controls\">\n          <button className=\"button-primary\" onClick={addTrack}>\n            â• ãƒˆãƒ©ãƒƒã‚¯è¿½åŠ \n          </button>\n          <button \n            className=\"button-secondary\" \n            onClick={() => setShowSoundPanel(!showSoundPanel)}\n          >\n            {showSoundPanel ? 'ğŸµ éŸ³ç´ æã‚’éš ã™' : 'ğŸµ éŸ³ç´ æã‚’è¡¨ç¤º'}\n          </button>\n        </div>\n\n        <div className=\"project-controls\">\n          <button className=\"button-secondary\" onClick={saveProject}>\n            ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜\n          </button>\n          <label className=\"button-secondary file-input-label\">\n            ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿\n            <input\n              type=\"file\"\n              accept=\".json\"\n              onChange={loadProject}\n              style={{ display: 'none' }}\n            />\n          </label>\n          <button \n            className=\"button-warning\" \n            onClick={() => {\n              if (window.confirm('ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ\\n\\nç¾åœ¨ã®ä½œæ¥­å†…å®¹ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {\n                clearAutoSave();\n              }\n            }}\n            title=\"ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªå‹•ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢ï¼‰\"\n          >\n            ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ\n          </button>\n          <button \n            className=\"button-primary\" \n            onClick={exportAudio}\n            disabled={isExporting}\n          >\n            {isExporting ? 'ğŸ”„ å‡ºåŠ›ä¸­...' : 'ğŸ§ éŸ³æºå‡ºåŠ›'}\n          </button>\n        </div>\n      </div>\n\n      <div className=\"daw-main-area\">\n        <div className={`sound-panel ${!showSoundPanel ? 'panel-hidden' : ''}`}>\n          <div className=\"sound-panel-header\">\n            <h3>ğŸµ éŸ³ç´ æ</h3>\n            <button \n              className=\"sound-panel-close\"\n              onClick={() => setShowSoundPanel(false)}\n              title=\"éŸ³ç´ æãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹\"\n            >\n              âœ•\n            </button>\n          </div>\n          <div className=\"sound-list\">\n            {sounds.length > 0 ? (\n              sounds.map(sound => (\n                <SoundItem \n                  key={sound.id} \n                  sound={sound} \n                  onDragStart={async (sound) => {\n                    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«éŸ³å£°ã®é•·ã•ã‚’è¨ˆç®—\n                    console.log('ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ - éŸ³å£°é•·ã•è¨ˆç®—ä¸­:', sound.name);\n                    if (sound.audioBlob) {\n                      try {\n                        const duration = await getAudioDuration(sound.audioBlob, bpm);\n                        console.log('è¨ˆç®—ã•ã‚ŒãŸéŸ³å£°é•·ã•:', duration, 'px');\n                        setDraggedSoundDuration(duration);\n                      } catch (error) {\n                        console.warn('ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®éŸ³å£°é•·ã•è¨ˆç®—ã«å¤±æ•—:', error);\n                        setDraggedSoundDuration(400);\n                      }\n                    } else {\n                      console.log('audioBlob ãŒå­˜åœ¨ã—ã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨');\n                      setDraggedSoundDuration(400);\n                    }\n                  }}\n                />\n              ))\n            ) : (\n              <div className=\"no-sounds\">\n                <p>éŸ³ç´ æãŒã‚ã‚Šã¾ã›ã‚“</p>\n                <p>ã€ŒéŸ³ã‚ã¤ã‚ã€ãƒšãƒ¼ã‚¸ã§éŸ³ã‚’éŒ²éŸ³ã—ã¦ãã ã•ã„</p>\n              </div>\n            )}\n          </div>\n        </div>\n\n        <div className={`daw-workspace ${!showSoundPanel ? 'panel-hidden' : ''}`}>\n          <div className=\"track-headers\">\n            <div className=\"timeline-header-spacer\">\n              ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³\n            </div>\n            {tracks.map(track => (\n              <TrackHeader \n                key={track.id} \n                track={track} \n                onRemove={removeTrack}\n                trackHeight={trackHeight}\n              />\n            ))}\n          </div>\n\n          <div className=\"timeline-container\">\n            <Timeline bpm={bpm} />\n            <div className=\"tracks-area\" ref={timelineRef} style={{ minWidth: TOTAL_MEASURES * MEASURE_WIDTH }}>\n              <Playhead currentTime={currentTime} />\n              {dragPreview && (\n                <div \n                  className=\"drag-preview\"\n                  style={{\n                    left: dragPreview.left,\n                    top: dragPreview.top,\n                    width: dragPreview.width\n                  }}\n                />\n              )}\n              {tracks.map(track => (\n                <Track\n                  key={track.id}\n                  track={track}\n                  onDrop={handleDrop}\n                  onDragOver={handleDragOver}\n                  onRemoveClip={removeClip}\n                  onClipDragStart={handleClipDragStart}\n                  onDragEnd={handleDragEnd}\n                  trackHeight={trackHeight}\n                  bpm={bpm}\n                  updateDragPreview={updateDragPreview}\n                />\n              ))}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"instructions card\">\n        <h3>ğŸ“– ä½¿ã„æ–¹</h3>\n        <ul>\n          <li><strong>ğŸ–¥ï¸ PC:</strong> å·¦å´ã®éŸ³ç´ æãƒ‘ãƒãƒ«ã‹ã‚‰éŸ³ç´ æã‚’ãƒˆãƒ©ãƒƒã‚¯ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦é…ç½®</li>\n          <li><strong>ğŸ“± ã‚¹ãƒãƒ›/ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ:</strong> éŸ³ç´ æã‚’é•·æŠ¼ã—ã—ã¦ã‹ã‚‰ãƒˆãƒ©ãƒƒã‚¯ã¾ã§ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é…ç½®</li>\n          <li>é…ç½®æ¸ˆã¿ã®éŸ³ç´ æã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦åˆ¥ã®å ´æ‰€ã«ç§»å‹•ã§ãã¾ã™</li>\n          <li>ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯é…ç½®äºˆå®šä½ç½®ã«é’ã„å½±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>\n          <li>éŸ³ç´ æã¯8åˆ†éŸ³ç¬¦ï¼ˆè£æ‹å«ã‚€ï¼‰ã«åˆã‚ã›ã¦è‡ªå‹•çš„ã«é…ç½®ã•ã‚Œã¾ã™</li>\n          <li>éŸ³ç´ æãƒ‘ãƒãƒ«ã®â–¶ï¸ãƒœã‚¿ãƒ³ã§å€‹åˆ¥ã«éŸ³ã‚’ç¢ºèªã§ãã¾ã™</li>\n          <li>â–¶ï¸ãƒœã‚¿ãƒ³ã§å†ç”Ÿã€â¸ï¸ãƒœã‚¿ãƒ³ã§ä¸€æ™‚åœæ­¢ã€â¹ï¸ãƒœã‚¿ãƒ³ã§åœæ­¢</li>\n          <li>BPMã‚’å¤‰æ›´ã—ã¦éŸ³æ¥½ã®é€Ÿã•ã‚’èª¿æ•´</li>\n          <li>ãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ ã—ã¦è¤‡æ•°ã®éŸ³ã‚’é‡ã­ã‚‹ã“ã¨ãŒã§ãã¾ã™</li>\n          <li><strong>ğŸ’¾ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜:</strong> ç·¨é›†ä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜</li>\n          <li><strong>ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿:</strong> ä¿å­˜ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ç·¨é›†ã‚’å†é–‹</li>\n          <li><strong>ğŸ§ éŸ³æºå‡ºåŠ›:</strong> å®Œæˆã—ãŸæ¥½æ›²ã‚’WAVãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦å‡ºåŠ›</li>\n          <li><strong>ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ:</strong> ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦æ–°ã—ãå§‹ã‚ã‚‹</li>\n        </ul>\n        <div className=\"auto-save-info\">\n          <h4>ğŸ’¾ è‡ªå‹•ä¿å­˜æ©Ÿèƒ½</h4>\n          <ul>\n            <li><strong>è‡ªå‹•ä¿å­˜:</strong> ãƒˆãƒ©ãƒƒã‚¯ã‚„BPMã®å¤‰æ›´ã¯è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™</li>\n            <li><strong>ä»–ãƒšãƒ¼ã‚¸ã¨ã®é€£æº:</strong> ã€ŒéŸ³ã‚ã¤ã‚ã€ãƒšãƒ¼ã‚¸ã§éŒ²éŸ³ã—ãŸéŸ³ã¯è‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã¾ã™</li>\n            <li><strong>å¾©å…ƒæ©Ÿèƒ½:</strong> ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ä½œæ¥­å†…å®¹ãŒè‡ªå‹•çš„ã«å¾©å…ƒã•ã‚Œã¾ã™</li>\n            <li><strong>å®‰å¿ƒã—ã¦ç§»å‹•:</strong> ä»–ã®ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¦ã‚‚ä½œæ¥­å†…å®¹ã¯ä¿æŒã•ã‚Œã¾ã™</li>\n          </ul>\n        </div>\n        <div className=\"mobile-tips\">\n          <h4>ğŸ“± ã‚¹ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ³åˆ©ç”¨ã®ã‚³ãƒ„</h4>\n          <ul>\n            <li>éŸ³ç´ æã‚’è»½ãé•·æŠ¼ã—ã™ã‚‹ã¨ãƒ‰ãƒ©ãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™</li>\n            <li>ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã¯ç”»é¢ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ã‚ˆã†åˆ¶å¾¡ã•ã‚Œã¾ã™</li>\n            <li>é’ããƒã‚¤ãƒ©ã‚¤ãƒˆã•ã‚ŒãŸãƒˆãƒ©ãƒƒã‚¯ã§æŒ‡ã‚’é›¢ã™ã¨éŸ³ç´ æãŒé…ç½®ã•ã‚Œã¾ã™</li>\n            <li>æ¨ªç”»é¢è¡¨ç¤ºã«ã™ã‚‹ã¨ã‚ˆã‚Šä½¿ã„ã‚„ã™ããªã‚Šã¾ã™</li>\n          </ul>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst SoundItem = ({ sound, onDragStart }) => {\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [isDragging, setIsDragging] = useState(false);\n  const [touchStart, setTouchStart] = useState(null);\n  const [touchMove, setTouchMove] = useState(null);\n\n  const handleDragStart = (e) => {\n    // audioBlobä»¥å¤–ã®ãƒ‡ãƒ¼ã‚¿ã‚’JSONæ–‡å­—åˆ—ã¨ã—ã¦è¨­å®š\n    const soundDataForTransfer = {\n      ...sound,\n      audioBlob: null // Blobã¯ç›´æ¥ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚ºã§ããªã„ãŸã‚ä¸€æ™‚çš„ã«nullã«\n    };\n    \n    e.dataTransfer.setData('application/json', JSON.stringify(soundDataForTransfer));\n    e.dataTransfer.effectAllowed = 'copy';\n    \n    // å®Ÿéš›ã®audioBlobã¯åˆ¥é€”ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ\n    window.currentDraggedSoundBlob = sound.audioBlob;\n    \n    // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®onDragStarté–¢æ•°ã‚’å‘¼ã³å‡ºã—ï¼ˆéŸ³å£°ã®é•·ã•ã‚’è¨ˆç®—ï¼‰\n    if (onDragStart) {\n      onDragStart(sound);\n    }\n  };\n\n  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œ\n  const handleTouchStart = (e) => {\n    const touch = e.touches[0];\n    setTouchStart({ x: touch.clientX, y: touch.clientY });\n    setIsDragging(false);\n    \n    // é•·æŠ¼ã—åˆ¤å®šç”¨ã®ã‚¿ã‚¤ãƒãƒ¼ã¯è¨­å®šã›ãšã€ç§»å‹•æ¤œçŸ¥ã§ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°ã‚’é–‹å§‹\n  };\n\n  const handleTouchMove = (e) => {\n    if (!touchStart) return;\n    \n    const touch = e.touches[0];\n    const currentPos = { x: touch.clientX, y: touch.clientY };\n    setTouchMove(currentPos);\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®åˆ¤å®šï¼ˆ15pxä»¥ä¸Šç§»å‹•ï¼‰- é–¾å€¤ã‚’ä¸Šã’ã¦ã‚ˆã‚Šæ„å›³çš„ãªç§»å‹•ã®ã¿ãƒ‰ãƒ©ãƒƒã‚°æ‰±ã„\n    const deltaX = Math.abs(currentPos.x - touchStart.x);\n    const deltaY = Math.abs(currentPos.y - touchStart.y);\n    \n    if (!isDragging && (deltaX > 15 || deltaY > 15)) {\n      setIsDragging(true);\n      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰ï¼‰\n      document.body.classList.add('dragging');\n      \n      // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®onDragStarté–¢æ•°ã‚’å‘¼ã³å‡ºã—\n      if (onDragStart) {\n        onDragStart(sound);\n      }\n      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š\n      window.currentDraggedSoundBlob = sound.audioBlob;\n      window.currentDraggedSound = sound;\n    }\n    \n    if (isDragging) {\n      // passiveã‚¤ãƒ™ãƒ³ãƒˆã§ã¯preventDefaultãŒä½¿ãˆãªã„ã®ã§ã€ä»£ã‚ã‚Šã«touchActionã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’åˆ¶å¾¡\n      \n      // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°\n      const dragPreview = document.querySelector('.mobile-drag-preview');\n      if (dragPreview) {\n        dragPreview.style.left = `${currentPos.x - 50}px`;\n        dragPreview.style.top = `${currentPos.y - 20}px`;\n      }\n      \n      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ\n      const elementBelow = document.elementFromPoint(currentPos.x, currentPos.y);\n      const trackElement = elementBelow?.closest('.track');\n      \n      // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\n      document.querySelectorAll('.track').forEach(track => {\n        track.classList.remove('drag-over');\n      });\n      \n      // æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ \n      if (trackElement) {\n        trackElement.classList.add('drag-over');\n      }\n    }\n  };\n\n  const handleTouchEnd = (e) => {\n    if (isDragging && touchMove) {\n      // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\n      const elementBelow = document.elementFromPoint(touchMove.x, touchMove.y);\n      const trackElement = elementBelow?.closest('.track');\n      \n      if (trackElement) {\n        const trackId = parseInt(trackElement.dataset.trackId);\n        const rect = trackElement.getBoundingClientRect();\n        const timePosition = touchMove.x - rect.left;\n        \n        // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«\n        const dropEvent = new CustomEvent('mobileDrop', {\n          detail: {\n            trackId,\n            timePosition,\n            sound: sound\n          }\n        });\n        trackElement.dispatchEvent(dropEvent);\n      }\n    }\n    \n    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTouchStart(null);\n    setTouchMove(null);\n    setIsDragging(false);\n    \n    // SoundItem å†…ã§ã®ç›´æ¥ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    document.body.classList.remove('dragging');\n    \n    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\n    document.querySelectorAll('.track').forEach(track => {\n      track.classList.remove('drag-over');\n    });\n    \n    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤\n    const mobileDragPreview = document.querySelector('.mobile-drag-preview');\n    if (mobileDragPreview) {\n      mobileDragPreview.remove();\n    }\n    \n    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ã‚¯ãƒªã‚¢\n    if (window.currentDraggedSoundBlob) {\n      window.currentDraggedSoundBlob = null;\n    }\n    if (window.currentDraggedSound) {\n      window.currentDraggedSound = null;\n    }\n  };\n\n  const playSound = () => {\n    if (sound.audioBlob && !isPlaying && !isDragging) {\n      // Blobã®æœ‰åŠ¹æ€§ã‚’ãƒã‚§ãƒƒã‚¯\n      if (!(sound.audioBlob instanceof Blob) || sound.audioBlob.size === 0) {\n        console.error('ç„¡åŠ¹ãªaudioBlob:', {\n          name: sound.name,\n          isBlob: sound.audioBlob instanceof Blob,\n          size: sound.audioBlob?.size\n        });\n        return;\n      }\n      \n      const audio = new Audio();\n      let audioUrl;\n      \n      try {\n        audioUrl = URL.createObjectURL(sound.audioBlob);\n        audio.src = audioUrl;\n        \n        audio.play()\n          .then(() => {\n            setIsPlaying(true);\n            \n            const handleEnded = () => {\n              setIsPlaying(false);\n              if (audioUrl) {\n                URL.revokeObjectURL(audioUrl); // URLã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n              }\n              audio.removeEventListener('ended', handleEnded);\n            };\n            \n            audio.addEventListener('ended', handleEnded);\n            \n            // éŸ³å£°ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚‚ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°\n            audio.addEventListener('error', (error) => {\n              console.error('éŸ³å£°èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);\n              setIsPlaying(false);\n              if (audioUrl) {\n                URL.revokeObjectURL(audioUrl);\n              }\n            });\n          })\n          .catch(error => {\n            console.error('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);\n            if (audioUrl) {\n              URL.revokeObjectURL(audioUrl); // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n            }\n            setIsPlaying(false);\n          });\n      } catch (error) {\n        console.error('createObjectURLã‚¨ãƒ©ãƒ¼:', error);\n        setIsPlaying(false);\n      }\n    } else {\n      console.log('å†ç”Ÿæ¡ä»¶ä¸æº€è¶³:', {\n        hasAudioBlob: !!sound.audioBlob,\n        isPlaying,\n        isDragging\n      });\n    }\n  };\n\n  // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä½œæˆ\n  const createDragPreview = useCallback(() => {\n    if (isDragging && touchMove) {\n      let dragPreview = document.querySelector('.mobile-drag-preview');\n      if (!dragPreview) {\n        dragPreview = document.createElement('div');\n        dragPreview.className = 'mobile-drag-preview';\n        dragPreview.textContent = sound.name;\n        dragPreview.style.cssText = `\n          position: fixed;\n          background: rgba(0, 123, 255, 0.8);\n          color: white;\n          padding: 5px 10px;\n          border-radius: 4px;\n          font-size: 12px;\n          pointer-events: none;\n          z-index: 1000;\n          left: ${touchMove.x - 50}px;\n          top: ${touchMove.y - 20}px;\n        `;\n        document.body.appendChild(dragPreview);\n      }\n    }\n  }, [isDragging, touchMove, sound.name]);\n\n  // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°\n  React.useEffect(() => {\n    if (isDragging) {\n      createDragPreview();\n    }\n  }, [isDragging, touchMove, createDragPreview]);\n\n  return (\n    <div\n      className={`sound-item ${isDragging ? 'dragging' : ''}`}\n      draggable=\"true\"\n      onDragStart={handleDragStart}\n      onTouchStart={handleTouchStart}\n      onTouchMove={handleTouchMove}\n      onTouchEnd={handleTouchEnd}\n    >\n      <div className=\"sound-info\">\n        <h4>{sound.name}</h4>\n        <div className=\"sound-tags\">\n          {sound.tags.map((tag, index) => (\n            <span key={index} className=\"sound-tag\">{tag}</span>\n          ))}\n        </div>\n      </div>\n      <div className=\"sound-actions\">\n        <button \n          className=\"play-sound-btn\"\n          onClick={playSound}\n          disabled={isPlaying}\n        >\n          {isPlaying ? 'â¸ï¸' : 'â–¶ï¸'}\n        </button>\n      </div>\n    </div>\n  );\n};\n\nconst TrackHeader = ({ track, onRemove, trackHeight }) => {\n  return (\n    <div className=\"track-header\" style={{ height: trackHeight }}>\n      <div className=\"track-info\">\n        <h4>{track.name}</h4>\n        <div className=\"track-actions\">\n          <button \n            className=\"remove-track-btn\"\n            onClick={() => onRemove(track.id)}\n            title=\"ãƒˆãƒ©ãƒƒã‚¯ã‚’å‰Šé™¤\"\n          >\n            ğŸ—‘ï¸\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n};\n\nconst Timeline = ({ bpm }) => {\n  const measures = TOTAL_MEASURES; // 16å°ç¯€è¡¨ç¤º\n  const beatsPerMeasure = BEATS_PER_MEASURE; // 4/4æ‹å­\n\n  return (\n    <div className=\"timeline\" style={{ minWidth: TOTAL_MEASURES * MEASURE_WIDTH }}>\n      {Array.from({ length: measures }, (_, measureIndex) => (\n        <div key={measureIndex} className=\"measure\">\n          <div className=\"measure-number\">{measureIndex + 1}</div>\n          <div className=\"beats\">\n            {Array.from({ length: beatsPerMeasure }, (_, beatIndex) => (\n              <div \n                key={beatIndex} \n                className=\"beat\"\n                style={{ width: BEAT_WIDTH }}\n              >\n                <div className=\"beat-main\">\n                  {beatIndex + 1}\n                </div>\n                <div className=\"beat-sub\">\n                  <div className=\"sub-beat-marker\">ãƒ»</div>\n                </div>\n              </div>\n            ))}\n          </div>\n        </div>\n      ))}\n    </div>\n  );\n};\n\nconst Track = ({ track, onDrop, onDragOver, onRemoveClip, onClipDragStart, onDragEnd, trackHeight, bpm, updateDragPreview }) => {\n  const handleDrop = (e) => {\n    const rect = e.currentTarget.getBoundingClientRect();\n    const timePosition = e.clientX - rect.left;\n    onDrop(e, track.id, timePosition);\n  };\n\n  // ãƒ¢ãƒã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†\n  const handleMobileDrop = useCallback((e) => {\n    const { trackId, timePosition, sound } = e.detail;\n    \n    // æ¨¡æ“¬çš„ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ\n    const mockDropEvent = {\n      preventDefault: () => {},\n      dataTransfer: {\n        getData: (type) => {\n          if (type === 'application/json') {\n            return JSON.stringify(sound);\n          }\n          return '';\n        }\n      }\n    };\n    \n    onDrop(mockDropEvent, trackId, timePosition);\n  }, [onDrop]);\n\n  // ãƒ¢ãƒã‚¤ãƒ«ã‚¯ãƒªãƒƒãƒ—ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã®å‡¦ç†\n  const handleMobileClipMove = useCallback((e) => {\n    const { clip, newTrackId, timePosition } = e.detail;\n    \n    // æ¨¡æ“¬çš„ãªãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½œæˆ\n    const mockDropEvent = {\n      preventDefault: () => {},\n      dataTransfer: {\n        getData: (type) => {\n          if (type === 'text/plain') {\n            return `existing-clip-${clip.id}`;\n          }\n          return '';\n        }\n      }\n    };\n    \n    onDrop(mockDropEvent, newTrackId, timePosition);\n  }, [onDrop]);\n\n  const handleUpdateDragPreview = useCallback((e) => {\n    const { clientX, trackElement } = e.detail;\n    // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®updateDragPreviewé–¢æ•°ã‚’å‘¼ã³å‡ºã—\n    if (typeof updateDragPreview === 'function') {\n      updateDragPreview(clientX, trackElement);\n    }\n  }, []);\n\n  React.useEffect(() => {\n    const trackElement = document.querySelector(`[data-track-id=\"${track.id}\"]`);\n    if (trackElement) {\n      trackElement.addEventListener('mobileDrop', handleMobileDrop);\n      trackElement.addEventListener('mobileClipMove', handleMobileClipMove);\n      trackElement.addEventListener('updateDragPreview', handleUpdateDragPreview);\n      return () => {\n        trackElement.removeEventListener('mobileDrop', handleMobileDrop);\n        trackElement.removeEventListener('mobileClipMove', handleMobileClipMove);\n        trackElement.removeEventListener('updateDragPreview', handleUpdateDragPreview);\n      };\n    }\n  }, [track.id, handleMobileDrop, handleMobileClipMove, handleUpdateDragPreview]);\n\n  return (\n    <div \n      className=\"track\"\n      style={{ height: trackHeight }}\n      data-track-id={track.id}\n      onDrop={handleDrop}\n      onDragOver={onDragOver}\n    >\n      <div className=\"track-grid\">\n        {/* è¡¨æ‹ï¼ˆä¸»è¦ãªæ‹ï¼‰ã®å¢ƒç•Œç·šã‚’è¡¨ç¤º */}\n        {Array.from({ length: TOTAL_BEATS }, (_, index) => {\n          const isFirstBeat = index === 0;\n          const isMeasureStart = index % BEATS_PER_MEASURE === 0;\n          const className = `beat-line beat-line-main ${isFirstBeat ? 'first-beat' : ''} ${isMeasureStart ? 'measure-start' : ''}`;\n          return (\n            <div key={`main-${index}`} className={className} style={{ left: index * BEAT_WIDTH }} />\n          );\n        })}\n        {/* è£æ‹ï¼ˆ8åˆ†éŸ³ç¬¦ï¼‰ã®å¢ƒç•Œç·šã‚’è¡¨ç¤º */}\n        {Array.from({ length: TOTAL_BEATS }, (_, index) => (\n          <div key={`sub-${index}`} className=\"beat-line beat-line-sub\" style={{ left: index * BEAT_WIDTH + SUB_BEAT_WIDTH }} />\n        ))}\n      </div>\n      \n      {track.clips.map(clip => (\n        <AudioClip\n          key={clip.id}\n          clip={clip}\n          trackId={track.id}\n          onRemove={() => onRemoveClip(track.id, clip.id)}\n          onDragStart={onClipDragStart}\n          onDragEnd={onDragEnd}\n        />\n      ))}\n    </div>\n  );\n};\n\nconst AudioClip = ({ clip, trackId, onRemove, onDragStart, onDragEnd }) => {\n  const [waveformData, setWaveformData] = React.useState([]);\n  const [isDragging, setIsDragging] = React.useState(false);\n  const [touchStart, setTouchStart] = React.useState(null);\n  const [touchMove, setTouchMove] = React.useState(null);\n\n  React.useEffect(() => {\n    // clip.soundData ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ\n    if (clip && clip.soundData) {\n      // ç°¡å˜ãªæ³¢å½¢ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆå®Ÿéš›ã®å®Ÿè£…ã§ã¯éŸ³å£°è§£æãŒå¿…è¦ï¼‰\n      const generateWaveform = () => {\n        const points = 20; // æ³¢å½¢ã®ãƒã‚¤ãƒ³ãƒˆæ•°\n        const data = [];\n        for (let i = 0; i < points; i++) {\n          data.push(Math.random() * 0.8 + 0.2); // 0.2-1.0ã®é–“ã®ãƒ©ãƒ³ãƒ€ãƒ å€¤\n        }\n        setWaveformData(data);\n      };\n\n      generateWaveform();\n    }\n  }, [clip, clip?.soundData]);\n\n  // clip.soundData ã®å®‰å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆHooksã®å¾Œã§ï¼‰\n  if (!clip || !clip.soundData) {\n    console.warn('ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿:', clip);\n    return null; // ç„¡åŠ¹ãªã‚¯ãƒªãƒƒãƒ—ã¯è¡¨ç¤ºã—ãªã„\n  }\n\n  const handleDragStart = (e) => {\n    e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ–ãƒªãƒ³ã‚°ã‚’é˜²ã\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°ãƒ‡ãƒ¼ã‚¿ã«æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®æƒ…å ±ã‚’è¨­å®š\n    e.dataTransfer.setData('text/plain', `existing-clip-${clip.id}`);\n    e.dataTransfer.effectAllowed = 'move';\n    \n    // onDragStartã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’å‘¼ã³å‡ºã—ï¼ˆãƒã‚¦ã‚¹ä½ç½®ã¨ã‚¯ãƒªãƒƒãƒ—è¦ç´ ã‚’æ¸¡ã™ï¼‰\n    onDragStart(clip, trackId, e.clientX, e.currentTarget);\n  };\n\n  const handleDragEnd = (e) => {\n    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å‘¼ã³å‡ºã—\n    if (onDragEnd) {\n      onDragEnd(e);\n    }\n  };\n\n  // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå¯¾å¿œï¼ˆã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ï¼‰\n  const handleTouchStart = (e) => {\n    e.stopPropagation();\n    const touch = e.touches[0];\n    setTouchStart({ x: touch.clientX, y: touch.clientY });\n    setIsDragging(false);\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã¯ç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰æœ‰åŠ¹åŒ–\n  };\n\n  const handleTouchMove = (e) => {\n    if (!touchStart) return;\n    \n    const touch = e.touches[0];\n    const currentPos = { x: touch.clientX, y: touch.clientY };\n    setTouchMove(currentPos);\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹ã®åˆ¤å®šï¼ˆ10pxä»¥ä¸Šç§»å‹•ï¼‰\n    const deltaX = Math.abs(currentPos.x - touchStart.x);\n    const deltaY = Math.abs(currentPos.y - touchStart.y);\n    \n    if (!isDragging && (deltaX > 10 || deltaY > 10)) {\n      setIsDragging(true);\n      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ï¼ˆç§»å‹•ãŒç¢ºå®šã—ã¦ã‹ã‚‰ï¼‰\n      document.body.classList.add('dragging');\n      onDragStart(clip, trackId, touchStart.x, e.currentTarget);\n    }\n    \n    if (isDragging) {\n      // passiveã‚¤ãƒ™ãƒ³ãƒˆã§ã¯preventDefaultãŒä½¿ãˆãªã„ã®ã§ã€touchActionã§åˆ¶å¾¡\n      \n      // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ\n      const elementBelow = document.elementFromPoint(currentPos.x, currentPos.y);\n      const trackElement = elementBelow?.closest('.track');\n      \n      // æ—¢å­˜ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\n      document.querySelectorAll('.track').forEach(track => {\n        track.classList.remove('drag-over');\n      });\n      \n      // æ–°ã—ã„ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’è¿½åŠ ï¼ˆè‡ªåˆ†ã®ãƒˆãƒ©ãƒƒã‚¯ä»¥å¤–ã‚‚å«ã‚€ï¼‰\n      if (trackElement) {\n        trackElement.classList.add('drag-over');\n        \n        // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚æ›´æ–°ï¼ˆonDragStartæ™‚ã¨åŒæ§˜ã®ãƒ­ã‚¸ãƒƒã‚¯ï¼‰\n        if (onDragStart) {\n          // è¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®updateDragPreviewé–¢æ•°ã‚’å‘¼ã³å‡ºã™ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ™ãƒ³ãƒˆ\n          const dragPreviewEvent = new CustomEvent('updateDragPreview', {\n            detail: {\n              clientX: currentPos.x,\n              trackElement: trackElement\n            }\n          });\n          trackElement.dispatchEvent(dragPreviewEvent);\n        }\n      }\n    }\n  };\n\n  const handleTouchEnd = (e) => {\n    if (isDragging && touchMove) {\n      // ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†\n      const elementBelow = document.elementFromPoint(touchMove.x, touchMove.y);\n      const trackElement = elementBelow?.closest('.track');\n      \n      if (trackElement) {\n        const newTrackId = parseInt(trackElement.dataset.trackId);\n        const rect = trackElement.getBoundingClientRect();\n        const timePosition = touchMove.x - rect.left;\n        \n        // æ—¢å­˜ã‚¯ãƒªãƒƒãƒ—ã®ç§»å‹•ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«\n        const moveEvent = new CustomEvent('mobileClipMove', {\n          detail: {\n            clip,\n            originalTrackId: trackId,\n            newTrackId,\n            timePosition\n          }\n        });\n        trackElement.dispatchEvent(moveEvent);\n      }\n    }\n    \n    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—\n    setTouchStart(null);\n    setTouchMove(null);\n    setIsDragging(false);\n    document.body.classList.remove('dragging');\n    \n    // ãƒã‚¤ãƒ©ã‚¤ãƒˆã‚’å‰Šé™¤\n    document.querySelectorAll('.track').forEach(track => {\n      track.classList.remove('drag-over');\n    });\n    \n    // ãƒ‰ãƒ©ãƒƒã‚°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆè¦ªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çŠ¶æ…‹ã‚‚ãƒªã‚»ãƒƒãƒˆï¼‰\n    if (onDragEnd) {\n      onDragEnd(null); // nullã‚’æ¸¡ã—ã¦ã‚¬ãƒ¼ãƒ‰æ¡ä»¶ã‚’æº€ãŸã™\n    }\n  };\n\n  return (\n    <div \n      className={`audio-clip ${isDragging ? 'dragging' : ''}`}\n      draggable=\"true\"\n      onDragStart={handleDragStart}\n      onDragEnd={handleDragEnd}\n      onTouchStart={handleTouchStart}\n      onTouchMove={handleTouchMove}\n      onTouchEnd={handleTouchEnd}\n      style={{\n        left: clip.startTime,\n        width: isFinite(clip.duration) && clip.duration > 0 ? clip.duration : 400 // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1å°ç¯€\n      }}\n    >\n      <div className=\"clip-header\">\n        <span className=\"clip-name\">{clip.soundData?.name || 'ä¸æ˜ãªéŸ³ç´ æ'}</span>\n        <button \n          className=\"remove-clip-btn\"\n          onClick={onRemove}\n          title=\"ã‚¯ãƒªãƒƒãƒ—ã‚’å‰Šé™¤\"\n        >\n          Ã—\n        </button>\n      </div>\n      <div className=\"clip-waveform\">\n        {waveformData.length > 0 ? (\n          <svg className=\"waveform-svg\" width=\"100%\" height=\"30\">\n            {waveformData.map((height, index) => (\n              <rect\n                key={index}\n                x={`${(index / waveformData.length) * 100}%`}\n                y={`${(1 - height) * 15}`}\n                width={`${80 / waveformData.length}%`}\n                height={`${height * 30}`}\n                fill=\"rgba(255, 255, 255, 0.8)\"\n              />\n            ))}\n          </svg>\n        ) : (\n          <div className=\"waveform-placeholder\">ğŸ”Š</div>\n        )}\n      </div>\n    </div>\n  );\n};\n\nconst Playhead = ({ currentTime }) => {\n  // currentTimeãŒæœ‰åŠ¹ãªæ•°å€¤ã‹ãƒã‚§ãƒƒã‚¯\n  const safeCurrentTime = isFinite(currentTime) && currentTime >= 0 ? currentTime : 0;\n  \n  return (\n    <div \n      className=\"playhead\"\n      style={{ left: safeCurrentTime }}\n    />\n  );\n};\n\nexport default DAWPage;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}